using System;
using System.Collections.Generic;
using System.Linq;
using System.Numerics;
using Content.Client.UserInterface.Controls;
using Content.Shared._RMC14.Vehicle;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.GameObjects;
using Robust.Shared.Localization;
using Robust.Shared.Maths;

namespace Content.Client._RMC14.Vehicle.Ui;

[GenerateTypedNameReferences]
public sealed partial class RMCVehicleWeaponsMenu : FancyWindow
{
    public event Action<string>? OnSelect;
    public event Action<bool>? OnToggleStabilization;
    public event Action<bool>? OnToggleAutoTurret;

    private readonly IEntityManager _entManager = IoCManager.Resolve<IEntityManager>();
    private readonly List<RMCVehicleWeaponsUiEntry> _hardpoints = new();

    private bool _suppressStabilization;
    private bool _suppressAuto;
    private string? _selectedSlotId;

    public RMCVehicleWeaponsMenu()
    {
        RobustXamlLoader.Load(this);
        ApplyWindowChromeStyle();
        ContentsContainer.Margin = new Thickness(0f);

        StabilizationToggle.OnToggled += args =>
        {
            if (_suppressStabilization)
                return;

            OnToggleStabilization?.Invoke(args.Pressed);
        };

        AutoTurretToggle.OnToggled += args =>
        {
            if (_suppressAuto)
                return;

            OnToggleAutoTurret?.Invoke(args.Pressed);
        };
    }

    public void Update(
        NetEntity vehicle,
        IReadOnlyList<RMCVehicleWeaponsUiEntry> hardpoints,
        bool canToggleStabilization,
        bool stabilizationEnabled,
        bool canToggleAuto,
        bool autoEnabled)
    {
        _ = vehicle;

        _suppressStabilization = true;
        StabilizationToggle.Disabled = !canToggleStabilization;
        StabilizationToggle.Pressed = stabilizationEnabled;
        StabilizationToggle.Text = stabilizationEnabled
            ? Loc.GetString("rmc-vehicle-weapons-ui-stabilization-on")
            : Loc.GetString("rmc-vehicle-weapons-ui-stabilization-off");
        _suppressStabilization = false;

        _suppressAuto = true;
        AutoTurretToggle.Disabled = !canToggleAuto;
        AutoTurretToggle.Pressed = autoEnabled;
        AutoTurretToggle.Text = autoEnabled
            ? Loc.GetString("rmc-vehicle-weapons-ui-auto-on")
            : Loc.GetString("rmc-vehicle-weapons-ui-auto-off");
        _suppressAuto = false;

        _hardpoints.Clear();
        _hardpoints.AddRange(hardpoints);

        SyncSelectedSlot();
        RebuildHardpointButtons();
        UpdateSelectedInfo();
    }

    private void ApplyWindowChromeStyle()
    {
        if (GetChild(0) is PanelContainer windowPanel)
        {
            windowPanel.PanelOverride = new StyleBoxFlat
            {
                BackgroundColor = Color.Transparent,
                BorderColor = Color.Transparent,
                BorderThickness = new Thickness(0f)
            };
        }
    }

    private void SyncSelectedSlot()
    {
        foreach (var hardpoint in _hardpoints)
        {
            if (!hardpoint.Selected)
                continue;

            _selectedSlotId = hardpoint.SlotId;
            return;
        }

        // Trust authoritative state from server: if no hardpoint is selected, clear local selection.
        _selectedSlotId = null;
    }

    private void RebuildHardpointButtons()
    {
        HardpointStrip.DisposeAllChildren();
        HardpointScroll.HScrollEnabled = _hardpoints.Count > 6;

        var ordered = _hardpoints
            .OrderBy(h => RMCVehicleTurretSlotIds.TryParse(h.SlotId, out _, out _) ? 1 : 0)
            .ThenBy(h => h.SlotId);

        foreach (var hardpoint in ordered)
        {
            var selected = _selectedSlotId != null &&
                           string.Equals(_selectedSlotId, hardpoint.SlotId, StringComparison.OrdinalIgnoreCase);

            var button = new ContainerButton
            {
                MinSize = new Vector2(48f, 56f),
                MaxSize = new Vector2(48f, 56f),
                MouseFilter = Control.MouseFilterMode.Stop,
            };

            button.StyleBoxOverride = new StyleBoxFlat
            {
                BackgroundColor = hardpoint.HasItem ? Color.FromHex("#0B1A29D8") : Color.FromHex("#08101A90"),
                BorderColor = selected ? Color.FromHex("#6BC7FF") : GetHardpointColor(hardpoint).WithAlpha(0.85f),
                BorderThickness = new Thickness(selected ? 2f : 1.2f)
            };

            button.ToolTip = GetHardpointDisplayName(hardpoint);
            button.OnPressed += _ =>
            {
                if (!hardpoint.Selectable)
                    return;

                var wasSelected = _selectedSlotId != null &&
                                  string.Equals(_selectedSlotId, hardpoint.SlotId, StringComparison.OrdinalIgnoreCase);
                _selectedSlotId = wasSelected ? null : hardpoint.SlotId;
                UpdateSelectedInfo();
                RebuildHardpointButtons();
                OnSelect?.Invoke(hardpoint.SlotId);
            };

            var column = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Vertical,
                SeparationOverride = 0,
                HorizontalAlignment = Control.HAlignment.Center,
                VerticalAlignment = Control.VAlignment.Center,
                MouseFilter = Control.MouseFilterMode.Ignore
            };

            var icon = new SpriteView
            {
                MinSize = new Vector2(38f, 38f),
                Stretch = SpriteView.StretchMode.Fill,
                OverrideDirection = Direction.South,
                HorizontalAlignment = Control.HAlignment.Center,
                VerticalAlignment = Control.VAlignment.Center,
                MouseFilter = Control.MouseFilterMode.Ignore
            };

            if (hardpoint.InstalledEntity is { } installedNet &&
                _entManager.TryGetEntity(installedNet, out var installed) &&
                installed is { } installedUid &&
                _entManager.EntityExists(installedUid))
            {
                icon.SetEntity(installedUid);
            }

            var integrityRatio = 0f;
            if (hardpoint.HasIntegrity && hardpoint.MaxIntegrity > 0f)
                integrityRatio = Math.Clamp(hardpoint.Integrity / hardpoint.MaxIntegrity, 0f, 1f);

            var integrityBar = new ProgressBar
            {
                MinValue = 0f,
                MaxValue = 1f,
                Value = integrityRatio,
                MinSize = new Vector2(38f, 4f),
                HorizontalAlignment = Control.HAlignment.Center,
                VerticalAlignment = Control.VAlignment.Bottom
            };

            integrityBar.BackgroundStyleBoxOverride = new StyleBoxFlat
            {
                BackgroundColor = Color.FromHex("#223345"),
                BorderColor = Color.Transparent,
                BorderThickness = new Thickness(0f)
            };

            integrityBar.ForegroundStyleBoxOverride = new StyleBoxFlat
            {
                BackgroundColor = hardpoint.HasIntegrity ? GetHardpointColor(hardpoint) : Color.FromHex("#4A5C70"),
                BorderColor = Color.Transparent,
                BorderThickness = new Thickness(0f)
            };

            column.AddChild(icon);
            column.AddChild(integrityBar);
            button.AddChild(column);
            HardpointStrip.AddChild(button);
        }
    }

    private void UpdateSelectedInfo()
    {
        if (!TryGetSelected(out var selected))
        {
            AmmoCounter.Visible = false;
            AmmoCounter.Text = string.Empty;
            return;
        }

        if (!HasAmmoDisplayData(selected))
        {
            AmmoCounter.Visible = false;
            AmmoCounter.Text = string.Empty;
            return;
        }

        AmmoCounter.Visible = true;
        AmmoCounter.Text = BuildAmmoCounter(selected);
    }

    private static bool HasAmmoDisplayData(RMCVehicleWeaponsUiEntry selected)
    {
        if (selected.HasAmmo)
            return true;

        if (selected.HasMagazineData && selected.MaxStoredMagazines > 0)
            return true;

        return false;
    }

    private static string BuildAmmoCounter(RMCVehicleWeaponsUiEntry selected)
    {
        var parts = new List<string>();

        if (selected.HasAmmo)
        {
            var max = selected.MagazineSize > 0 ? selected.MagazineSize : selected.AmmoCapacity;
            parts.Add($"Ammo: {selected.AmmoCount}/{max}");
        }
        if (selected.HasMagazineData && selected.MaxStoredMagazines > 0)
            parts.Add($"Stored: {selected.StoredMagazines}/{selected.MaxStoredMagazines}");

        return string.Join(" | ", parts);
    }

    private bool TryGetSelected(out RMCVehicleWeaponsUiEntry selected)
    {
        selected = default!;

        if (_selectedSlotId != null && TryGetEntry(_selectedSlotId, out selected))
            return true;

        var fallback = _hardpoints.FirstOrDefault(h => h.Selected) ?? _hardpoints.FirstOrDefault();
        if (fallback == null)
            return false;

        selected = fallback;
        return true;
    }

    private bool TryGetEntry(string slotId, out RMCVehicleWeaponsUiEntry entry)
    {
        foreach (var hardpoint in _hardpoints)
        {
            if (!string.Equals(hardpoint.SlotId, slotId, StringComparison.OrdinalIgnoreCase))
                continue;

            entry = hardpoint;
            return true;
        }

        entry = default!;
        return false;
    }

    private static string GetHardpointDisplayName(RMCVehicleWeaponsUiEntry hardpoint)
    {
        if (hardpoint.HasItem && !string.IsNullOrWhiteSpace(hardpoint.InstalledName))
            return hardpoint.InstalledName;

        if (RMCVehicleTurretSlotIds.TryParse(hardpoint.SlotId, out var parentSlot, out var childSlot))
            return $"{parentSlot}/{childSlot}";

        return hardpoint.SlotId;
    }

    private static Color GetHardpointColor(RMCVehicleWeaponsUiEntry hardpoint)
    {
        if (!hardpoint.HasItem)
            return Color.FromHex("#455668");

        if (!hardpoint.HasIntegrity || hardpoint.MaxIntegrity <= 0f)
            return Color.FromHex("#7AA8D1");

        var ratio = Math.Clamp(hardpoint.Integrity / hardpoint.MaxIntegrity, 0f, 1f);

        if (ratio >= 0.66f)
            return Lerp(Color.FromHex("#9CCD57"), Color.FromHex("#53D188"), (ratio - 0.66f) / 0.34f);

        if (ratio >= 0.33f)
            return Lerp(Color.FromHex("#D6C45A"), Color.FromHex("#9CCD57"), (ratio - 0.33f) / 0.33f);

        return Lerp(Color.FromHex("#D05E56"), Color.FromHex("#D6C45A"), ratio / 0.33f);
    }

    private static Color Lerp(Color from, Color to, float amount)
    {
        amount = Math.Clamp(amount, 0f, 1f);
        return new Color(
            from.R + (to.R - from.R) * amount,
            from.G + (to.G - from.G) * amount,
            from.B + (to.B - from.B) * amount,
            from.A + (to.A - from.A) * amount);
    }
}

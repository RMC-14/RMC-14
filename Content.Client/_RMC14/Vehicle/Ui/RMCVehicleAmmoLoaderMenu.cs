using System;
using System.Collections.Generic;
using System.Numerics;
using Content.Client.UserInterface.Controls;
using Content.Shared._RMC14.Vehicle;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Localization;
using Robust.Shared.Maths;
using Robust.Shared.GameObjects;
using Robust.Shared.Timing;

namespace Content.Client._RMC14.Vehicle.Ui;

[GenerateTypedNameReferences]
public sealed partial class RMCVehicleAmmoLoaderMenu : FancyWindow
{
    public event Action<string>? OnLoad;
    private readonly IEntityManager _entManager = IoCManager.Resolve<IEntityManager>();
    public EntityUid? LoaderEntity;
    private bool _loaderIconSet;

    public RMCVehicleAmmoLoaderMenu()
    {
        RobustXamlLoader.Load(this);
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);
        TrySetLoaderIcon();
    }

    private void TrySetLoaderIcon()
    {
        if (_loaderIconSet)
            return;

        if (LoaderEntity is not { } loader || !_entManager.EntityExists(loader))
            return;

        LoaderIcon.SetEntity(loader);
        LoaderIcon.OverrideDirection = Direction.South;
        _loaderIconSet = true;
    }

    public void Update(IReadOnlyList<RMCVehicleAmmoLoaderUiEntry> hardpoints, int ammoAmount, int ammoMax)
    {
        TrySetLoaderIcon();

        AmmoCountLabel.Text = Loc.GetString(
            "rmc-vehicle-ammo-loader-ui-ammo",
            ("current", ammoAmount),
            ("max", ammoMax));

        HardpointList.DisposeAllChildren();

        if (hardpoints.Count == 0)
        {
            HardpointList.AddChild(new Label
            {
                Text = Loc.GetString("rmc-vehicle-ammo-loader-ui-no-hardpoints"),
                FontColorOverride = Color.FromHex("#8FA7C2")
            });
            return;
        }

        foreach (var hardpoint in hardpoints)
        {
            var panel = new PanelContainer
            {
                HorizontalExpand = true,
                MinSize = new Vector2(0, 42)
            };

            panel.PanelOverride = new StyleBoxFlat
            {
                BackgroundColor = Color.FromHex("#0E1B2B"),
                BorderColor = Color.FromHex("#2D5E8E"),
                BorderThickness = new Thickness(1.5f)
            };

            var root = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Horizontal,
                SeparationOverride = 12,
                Margin = new Thickness(10, 10),
                HorizontalExpand = true
            };

            panel.AddChild(root);

            var spriteView = new SpriteView
            {
                Stretch = SpriteView.StretchMode.Fill,
                VerticalAlignment = Control.VAlignment.Center,
                MinSize = new Vector2(56, 56),
                OverrideDirection = Direction.South
            };

            if (hardpoint.InstalledEntity.HasValue &&
                _entManager.TryGetEntity(hardpoint.InstalledEntity.Value, out var installed) &&
                installed is { } installedUid &&
                _entManager.EntityExists(installedUid))
            {
                spriteView.SetEntity(installedUid);
            }

            root.AddChild(spriteView);

            var centerColumn = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Vertical,
                SeparationOverride = 3,
                HorizontalExpand = true
            };

            var header = Loc.GetString(
                "rmc-vehicle-ammo-loader-ui-slot",
                ("slot", hardpoint.SlotId),
                ("type", hardpoint.HardpointType));

            var nameText = hardpoint.InstalledName ?? header;

            centerColumn.AddChild(new Label
            {
                Text = nameText,
                FontColorOverride = Color.FromHex("#E1EEFF")
            });

            centerColumn.AddChild(new Label
            {
                Text = header,
                FontColorOverride = Color.FromHex("#8FA7C2")
            });

            centerColumn.AddChild(new Label
            {
                Text = Loc.GetString(
                    "rmc-vehicle-ammo-loader-ui-chambered",
                    ("current", hardpoint.ChamberedRounds),
                    ("max", hardpoint.MagazineSize)),
                FontColorOverride = Color.FromHex("#6BC7FF")
            });

            if (hardpoint.MaxStoredMagazines > 0)
            {
                centerColumn.AddChild(new Label
                {
                    Text = Loc.GetString(
                        "rmc-vehicle-ammo-loader-ui-stored",
                        ("current", hardpoint.StoredMagazines),
                        ("max", hardpoint.MaxStoredMagazines)),
                    FontColorOverride = Color.FromHex("#6BC7FF")
                });
            }

            var rightColumn = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Vertical,
                SeparationOverride = 8,
                VerticalAlignment = Control.VAlignment.Center,
                MinSize = new Vector2(130, 0)
            };

            var loadText = hardpoint.CanLoad
                ? Loc.GetString("rmc-vehicle-ammo-loader-ui-load")
                : hardpoint.ChamberedRounds > 0 && hardpoint.StoredMagazines >= hardpoint.MaxStoredMagazines
                    ? Loc.GetString("rmc-vehicle-ammo-loader-ui-full")
                    : Loc.GetString("rmc-vehicle-ammo-loader-ui-no-ammo");

            var loadButton = new RMCHardpointButton
            {
                LabelText = loadText,
                Disabled = !hardpoint.CanLoad,
                MinSize = new Vector2(98, 26)
            };

            loadButton.OnPressed += _ => OnLoad?.Invoke(hardpoint.SlotId);

            rightColumn.AddChild(loadButton);

            root.AddChild(centerColumn);
            root.AddChild(rightColumn);

            HardpointList.AddChild(panel);
        }
    }
}

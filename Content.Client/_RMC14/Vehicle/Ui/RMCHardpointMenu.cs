using System;
using System.Collections.Generic;
using Content.Shared._RMC14.Vehicle;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Maths;
using Robust.Shared.Localization;
using Content.Client.UserInterface.Controls;
using System.Numerics;

namespace Content.Client._RMC14.Vehicle.Ui;

[GenerateTypedNameReferences]
public sealed partial class RMCHardpointMenu : FancyWindow
{
    public event Action<string>? OnRemove;
    public RMCHardpointMenu()
    {
        RobustXamlLoader.Load(this);
    }

    public void Update(IReadOnlyList<RMCHardpointUiEntry> hardpoints)
    {
        HardpointList.DisposeAllChildren();

        foreach (var hardpoint in hardpoints)
        {
            var row = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Horizontal,
                SeparationOverride = 8,
            };

            var header = $"{hardpoint.SlotId} ({hardpoint.HardpointType})";
            var name = hardpoint.HasItem
                ? hardpoint.InstalledName ?? header
                : Loc.GetString("rmc-hardpoint-ui-empty-slot");

            row.AddChild(new Label
            {
                Text = name,
                MinSize = new Vector2(140f, 0f),
                HorizontalExpand = true,
            });

            if (hardpoint.HasIntegrity)
            {
                var bar = new ProgressBar
                {
                    MinValue = 0,
                    MaxValue = Math.Max(1f, hardpoint.MaxIntegrity),
                    Value = MathF.Max(0f, hardpoint.Integrity),
                MinSize = new Vector2(140f, 14f),
                    HorizontalExpand = true,
                };
                row.AddChild(bar);

                var percent = hardpoint.MaxIntegrity > 0f
                    ? MathF.Round(hardpoint.Integrity / hardpoint.MaxIntegrity * 100f)
                    : 0f;
                row.AddChild(new Label
                {
                    Text = Loc.GetString(
                        "rmc-hardpoint-ui-integrity",
                        ("current", MathF.Round(hardpoint.Integrity, 1)),
                        ("max", MathF.Round(hardpoint.MaxIntegrity, 1)),
                        ("percent", percent)),
                    HorizontalExpand = true,
                });
            }
            else
            {
                row.AddChild(new Label
                {
                    Text = Loc.GetString("rmc-hardpoint-ui-no-integrity"),
                    HorizontalExpand = true,
                });
            }

            var remove = new Button
            {
                Text = hardpoint.Removing
                    ? Loc.GetString("rmc-hardpoint-ui-removing")
                    : Loc.GetString("rmc-hardpoint-ui-remove"),
                Disabled = !hardpoint.HasItem || hardpoint.Removing,
            };
            remove.OnPressed += _ => OnRemove?.Invoke(hardpoint.SlotId);
            row.AddChild(remove);

            HardpointList.AddChild(row);
        }
    }
}

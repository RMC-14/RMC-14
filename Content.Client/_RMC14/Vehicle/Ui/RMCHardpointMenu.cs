using System;
using System.Collections.Generic;
using System.Numerics;
using Content.Client.UserInterface.Controls;
using Content.Shared._RMC14.Vehicle;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Localization;
using Robust.Shared.Maths;

namespace Content.Client._RMC14.Vehicle.Ui;

[GenerateTypedNameReferences]
public sealed partial class RMCHardpointMenu : FancyWindow
{
    public event Action<string>? OnRemove;

    public RMCHardpointMenu()
    {
        RobustXamlLoader.Load(this);
    }

    public void Update(IReadOnlyList<RMCHardpointUiEntry> hardpoints)
    {
        HardpointList.DisposeAllChildren();

        foreach (var hardpoint in hardpoints)
        {
            var isRemoving = hardpoint.Removing && !hardpoint.HasItem;

            var panel = new PanelContainer
            {
                HorizontalExpand = true,
                MinSize = new Vector2(0, 34)
            };

            panel.PanelOverride = new StyleBoxFlat
            {
                BackgroundColor = Color.FromHex("#0A1520"),
                BorderColor = Color.FromHex("#4AA3E8"),
                BorderThickness = new Thickness(1)
            };

            var root = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Vertical,
                SeparationOverride = 2,
                Margin = new Thickness(5, 4),
                HorizontalExpand = true
            };

            panel.AddChild(root);

            var header = $"{hardpoint.SlotId} ({hardpoint.HardpointType})";
            var nameText = hardpoint.HasItem
                ? hardpoint.InstalledName ?? header
                : Loc.GetString("rmc-hardpoint-ui-empty-slot");

            root.AddChild(new Label
            {
                Text = nameText,
                FontColorOverride = Color.FromHex("#88C7FA")
            });

            if (hardpoint.HasIntegrity)
            {
                var percent = hardpoint.MaxIntegrity > 0f
                    ? hardpoint.Integrity / hardpoint.MaxIntegrity
                    : 0f;

                var barRow = new BoxContainer
                {
                    Orientation = BoxContainer.LayoutOrientation.Horizontal,
                    SeparationOverride = 6,
                    HorizontalExpand = true
                };

                var barContainer = new Control
                {
                    MinSize = new Vector2(110, 10)
                };

                var bar = new ProgressBar
                {
                    MinValue = 0,
                    MaxValue = 1,
                    Value = percent,
                    MinSize = new Vector2(110, 10)
                };

                bar.ForegroundStyleBoxOverride = new StyleBoxFlat
                {
                    BackgroundColor = percent > 0.5f
                        ? Color.FromHex("#229132")
                        : percent > 0.25f
                            ? Color.FromHex("#CED22B")
                            : Color.FromHex("#A42625")
                };

                var percentLabel = new Label
                {
                    Text = $"{MathF.Round(percent * 100f)}%",
                    HorizontalAlignment = Control.HAlignment.Center,
                    VerticalAlignment = Control.VAlignment.Center,
                    FontColorOverride = Color.Black
                };

                barContainer.AddChild(bar);
                barContainer.AddChild(percentLabel);

                var remove = new RMCHardpointButton
                {
                    LabelText = isRemoving
                        ? Loc.GetString("rmc-hardpoint-ui-removing")
                        : Loc.GetString("rmc-hardpoint-ui-remove"),
                    Disabled = !hardpoint.HasItem || isRemoving,
                    MinSize = new Vector2(72, 20),
                    VerticalAlignment = Control.VAlignment.Center
                };

                remove.OnPressed += _ => OnRemove?.Invoke(hardpoint.SlotId);

                barRow.AddChild(barContainer);
                barRow.AddChild(remove);

                root.AddChild(barRow);
            }
            else
            {
                root.AddChild(new Label
                {
                    Text = Loc.GetString("rmc-hardpoint-ui-no-integrity"),
                    FontColorOverride = Color.FromHex("#88C7FA")
                });
            }

            HardpointList.AddChild(panel);
        }
    }
}

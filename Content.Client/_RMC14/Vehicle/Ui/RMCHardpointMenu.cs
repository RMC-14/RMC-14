using System;
using System.Collections.Generic;
using System.Numerics;
using Content.Client.UserInterface.Controls;
using Content.Shared._RMC14.Vehicle;
using Robust.Client.GameObjects;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Localization;
using Robust.Shared.Maths;
using Robust.Shared.Timing;
using Robust.Shared.Utility;
using Robust.Shared.GameObjects;

namespace Content.Client._RMC14.Vehicle.Ui;

[GenerateTypedNameReferences]
public sealed partial class RMCHardpointMenu : FancyWindow
{
    public event Action<string>? OnRemove;
    private readonly IEntityManager _entManager = IoCManager.Resolve<IEntityManager>();
    public EntityUid? VehicleEntity;
    private bool _vehicleIconSet;
    private float _vehicleSpin;
    private const float VehicleSpinSpeed = MathHelper.TwoPi / 6f;

    public RMCHardpointMenu()
    {
        RobustXamlLoader.Load(this);
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        TrySetVehicleIcon();
        SpinVehicleIcon(args.DeltaSeconds);
    }

    private void SpinVehicleIcon(float frameTime)
    {
        if (!_vehicleIconSet || VehicleEntity == null || !_entManager.EntityExists(VehicleEntity.Value))
            return;

        _vehicleSpin += frameTime * VehicleSpinSpeed;

        if (_vehicleSpin > MathHelper.TwoPi)
            _vehicleSpin -= MathHelper.TwoPi;

        VehicleIcon.OverrideDirection = new Angle(_vehicleSpin).GetDir();
    }

    private void TrySetVehicleIcon()
    {
        if (_vehicleIconSet)
            return;

        if (VehicleEntity is not { } vehicle || !_entManager.EntityExists(vehicle))
            return;

        VehicleIcon.SetEntity(vehicle);
        VehicleIcon.OverrideDirection = Direction.South;
        _vehicleSpin = 0f;
        _vehicleIconSet = true;
    }

    public void Update(
        IReadOnlyList<RMCHardpointUiEntry> hardpoints,
        float frameIntegrity,
        float frameMaxIntegrity,
        bool hasFrameIntegrity)
    {
        TrySetVehicleIcon();

        HardpointList.DisposeAllChildren();

        if (hasFrameIntegrity && frameMaxIntegrity > 0f)
        {
            var percent = Math.Clamp(frameIntegrity / frameMaxIntegrity, 0f, 1f);
            FrameHealthRow.Visible = true;
            FrameHealthBar.Value = percent;
            FrameHealthBar.ForegroundStyleBoxOverride = CreateIntegrityStyle(percent);
            FrameHealthLabel.Text = $"{MathF.Round(percent * 100f)}%";
        }
        else
        {
            FrameHealthRow.Visible = false;
        }

        foreach (var hardpoint in hardpoints)
        {
            var isRemoving = hardpoint.Removing;

            var panel = new PanelContainer
            {
                HorizontalExpand = true,
                MinSize = new Vector2(0, 42)
            };

            panel.PanelOverride = new StyleBoxFlat
            {
                BackgroundColor = Color.FromHex("#0E1B2B"),
                BorderColor = Color.FromHex("#2D5E8E"),
                BorderThickness = new Thickness(1.5f)
            };

            var root = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Horizontal,
                SeparationOverride = 12,
                Margin = new Thickness(10, 10),
                HorizontalExpand = true
            };

            panel.AddChild(root);

            var spriteView = new SpriteView
            {
                Stretch = SpriteView.StretchMode.Fill,
                VerticalAlignment = Control.VAlignment.Center,
                MinSize = new Vector2(56, 56),
                OverrideDirection = Direction.South
            };

            if (hardpoint.InstalledEntity.HasValue &&
                _entManager.TryGetEntity(hardpoint.InstalledEntity.Value, out var installed) &&
                installed is { } installedUid &&
                _entManager.EntityExists(installedUid))
            {
                spriteView.SetEntity(installedUid);
            }

            root.AddChild(spriteView);

            var centerColumn = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Vertical,
                SeparationOverride = 3,
                HorizontalExpand = true
            };

            var header = $"{hardpoint.SlotId} ({hardpoint.HardpointType})";
            var nameText = hardpoint.HasItem
                ? hardpoint.InstalledName ?? header
                : Loc.GetString("rmc-hardpoint-ui-empty-slot");

            centerColumn.AddChild(new Label
            {
                Text = nameText,
                FontColorOverride = Color.FromHex("#E1EEFF")
            });

            centerColumn.AddChild(new Label
            {
                Text = hardpoint.HasItem ? header : $"Slot: {header}",
                FontColorOverride = Color.FromHex("#8FA7C2")
            });

            var rightColumn = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Vertical,
                SeparationOverride = 8,
                VerticalAlignment = Control.VAlignment.Center,
                MinSize = new Vector2(130, 0)
            };

            var remove = new RMCHardpointButton
            {
                LabelText = isRemoving
                    ? Loc.GetString("rmc-hardpoint-ui-removing")
                    : Loc.GetString("rmc-hardpoint-ui-remove"),
                Disabled = !hardpoint.HasItem || isRemoving,
                MinSize = new Vector2(98, 26),
                Pulse = isRemoving
            };

            remove.OnPressed += _ => OnRemove?.Invoke(hardpoint.SlotId);

            rightColumn.AddChild(remove);

            if (hardpoint.HasIntegrity)
            {
                var percent = hardpoint.MaxIntegrity > 0f
                    ? Math.Clamp(hardpoint.Integrity / hardpoint.MaxIntegrity, 0f, 1f)
                    : 0f;

                var barRow = new BoxContainer
                {
                    Orientation = BoxContainer.LayoutOrientation.Horizontal,
                    SeparationOverride = 8,
                    HorizontalExpand = true
                };

                var bar = new ProgressBar
                {
                    MinValue = 0,
                    MaxValue = 1,
                    Value = percent,
                    HorizontalExpand = true,
                    MinSize = new Vector2(130, 16)
                };

                bar.ForegroundStyleBoxOverride = CreateIntegrityStyle(percent);

                var percentLabel = new Label
                {
                    Text = $"{MathF.Round(percent * 100f)}%",
                    VerticalAlignment = Control.VAlignment.Center,
                    FontColorOverride = Color.FromHex("#6BC7FF")
                };

                barRow.AddChild(bar);
                barRow.AddChild(percentLabel);

                rightColumn.AddChild(barRow);
            }
            else
            {
                rightColumn.AddChild(new Label
                {
                    Text = Loc.GetString("rmc-hardpoint-ui-no-integrity"),
                    FontColorOverride = Color.FromHex("#6BC7FF")
                });
            }

            root.AddChild(centerColumn);
            root.AddChild(rightColumn);

            HardpointList.AddChild(panel);
        }
    }

    private static StyleBoxFlat CreateIntegrityStyle(float percent)
    {
        var color = percent > 0.5f
            ? Color.FromHex("#53D188")
            : percent > 0.25f
                ? Color.FromHex("#D6C45A")
                : Color.FromHex("#E1786A");

        return new StyleBoxFlat
        {
            BackgroundColor = color
        };
    }
}

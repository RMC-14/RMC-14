using System.Numerics;
using Content.Client.Stylesheets;
using Content.Client.UserInterface.Controls;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using static Robust.Client.UserInterface.Controls.BoxContainer;

namespace Content.Client._RMC14.Attachable.Ui;

[GenerateTypedNameReferences]
public sealed partial class AttachableHolderStripMenu : FancyWindow
{
    private readonly Dictionary<string, AttachableSlotControl> _attachableSlotControls;

    public AttachableHolderStripMenu()
    {
        RobustXamlLoader.Load(this);
        _attachableSlotControls = new Dictionary<string, AttachableSlotControl>();
    }

    public void UpdateMenu(Dictionary<string, (string? attachableName, bool locked)> attachableSlots, Action<string> onPressed)
    {
        foreach (var slotId in attachableSlots.Keys)
        {
            if (!_attachableSlotControls.ContainsKey(slotId))
                AddSlotControl(slotId, onPressed);

            _attachableSlotControls[slotId].Update(attachableSlots[slotId].attachableName, attachableSlots[slotId].locked);
        }
    }

    private void AddSlotControl(string slotId, Action<string> onPressed)
    {
        var slotControl = new AttachableSlotControl(slotId, onPressed);
        AttachablesContainer.AddChild(slotControl);
        _attachableSlotControls.Add(slotId, slotControl);
    }

    private sealed class AttachableSlotControl : Control
    {
        private readonly Button _attachableButton;

        public AttachableSlotControl(string slotId, Action<string> onPressed)
        {
            var slotLabel = new Label
            {
                Text = Loc.GetString(slotId) + ':',
                HorizontalAlignment = HAlignment.Left,
            };

            _attachableButton = new Button
            {
                Text = Loc.GetString("rmc-attachable-holder-strip-ui-empty-slot"),
                HorizontalExpand = true,
                HorizontalAlignment = HAlignment.Right,
                StyleClasses = { StyleBase.ButtonOpenRight }
            };

            var hBox = new BoxContainer
            {
                Orientation = LayoutOrientation.Horizontal,
                Children =
                {
                    new Control { MinSize = new Vector2(5, 0) },
                    slotLabel,
                    new Control { MinSize = new Vector2(5, 0) },
                    _attachableButton,
                },
            };

            _attachableButton.OnPressed += _ => onPressed(slotId);
            AddChild(hBox);
        }

        public void Update(string? attachableName, bool slotLocked)
        {
            if (attachableName == null)
            {
                _attachableButton.Text = Loc.GetString("rmc-attachable-holder-strip-ui-empty-slot");
                _attachableButton.Disabled = true;
                return;
            }

            _attachableButton.Text = attachableName;
            _attachableButton.Disabled = slotLocked;
        }
    }
}

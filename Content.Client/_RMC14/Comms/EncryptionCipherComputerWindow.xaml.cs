using Content.Client.UserInterface.Controls;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using System.Numerics;

namespace Content.Client._RMC14.Comms;

[GenerateTypedNameReferences]
public sealed partial class EncryptionCipherComputerWindow : FancyWindow
{
    public event Action<int>? ChangeSetting;
    public event Action? Print;
    public event Action? Refill;

    public event Action<int,int>? ShiftLetter;

    public string InputCode
    {
        get => InputCodeLabel.Text ?? "";
        set
        {
            InputCodeLabel.Text = value;
            RebuildLetterAdjust();
        }
    }

    public int CipherSetting
    {
        get => int.TryParse(SettingLabel.Text, out var s) ? s : 0;
        set => SettingLabel.Text = value.ToString();
    }

    public string DecipheredWord
    {
        get => WordLabel.Text ?? "";
        set => WordLabel.Text = value;
    }

    public bool ValidWord
    {
        get => ValidLabel.Text == "Valid Word: Yes";
        set => ValidLabel.Text = "Valid Word: " + (value ? "Yes" : "No");
    }

    public string StatusMessage
    {
        get => StatusLabel.Text ?? "Ready for input";
        set => StatusLabel.Text = value;
    }

    public int PunchcardCount
    {
        get => int.TryParse(PunchcardCountLabel.Text?.Replace("Punchcards: ", ""), out var c) ? c : 10;
        set => PunchcardCountLabel.Text = $"Punchcards: {value}";
    }

    private void RebuildLetterAdjust()
    {
        // Clear existing
        LetterAdjustContainer.RemoveAllChildren();

        var parts = InputCode.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        for (var i = 0; i < parts.Length; i++)
        {
            var part = parts[i];
            string display = part;
            if (part.StartsWith("0x", StringComparison.InvariantCultureIgnoreCase) &&
                int.TryParse(part.Substring(2), System.Globalization.NumberStyles.HexNumber, null, out var v))
            {
                display = ((char)v).ToString();
            }

            var vbox = new BoxContainer { Orientation = BoxContainer.LayoutOrientation.Vertical, SeparationOverride = 2 };
            var up = new Button { Text = "^", MinSize = new Vector2(20, 20) };
            var lbl = new Label { Text = display, HorizontalExpand = false };
            var down = new Button { Text = "v", MinSize = new Vector2(20, 20) };

            var index = i; // capture
            up.OnPressed += _ => ShiftLetter?.Invoke(index, +1);
            down.OnPressed += _ => ShiftLetter?.Invoke(index, -1);

            vbox.AddChild(up);
            vbox.AddChild(lbl);
            vbox.AddChild(down);

            LetterAdjustContainer.AddChild(vbox);
        }
    }
    public EncryptionCipherComputerWindow()
    {
        RobustXamlLoader.Load(this);

        DecreaseButton.OnPressed += _ => ChangeSetting?.Invoke(-1);
        IncreaseButton.OnPressed += _ => ChangeSetting?.Invoke(1);

        PrintButton.OnPressed += _ => Print?.Invoke();

        RefillButton.OnPressed += _ => Refill?.Invoke();
    }
}

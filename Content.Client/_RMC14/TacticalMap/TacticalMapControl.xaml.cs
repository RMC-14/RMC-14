using System.Collections.Generic;
using System.Numerics;
using Content.Shared._RMC14.Areas;
using Content.Shared._RMC14.TacticalMap;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.ResourceManagement;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.GameObjects;
using Robust.Shared.IoC;
using Robust.Shared.Maths;
using Color = Robust.Shared.Maths.Color;

namespace Content.Client._RMC14.TacticalMap;

[GenerateTypedNameReferences]
public sealed partial class TacticalMapControl : TextureRect
{
    public enum LabelMode
    {
        All = 0,
        Tactical = 1,
        Area = 2,
        None = 3
    }

    private const float MapScale = 3f;
    private const float MapTileOpacity = 0.85f;
    private const float BaseBlipSize = 14f;
    private const float ClickTolerance = 8f;
    private const float BlipEdgeRatio = 0.7f;
    private const float CloseBlipThreshold = 2.2f;
    private const float CloseBlipSafety = 0.8f;
    private const int DashLength = 6;
    private const int GapLength = 3;
    private const int ArrowLength = 15;
    private const int ArrowWidth = 8;
    private const float MinDragDistance = 10f;
    private const float MinFreehandSegmentPixels = 6f;
    private const float MinEraserSegmentPixels = 3f;
    private const float SmoothSamplePixels = 4f;
    private const float LineJoinEpsilon = 0.05f;
    private const float LineSoftEdgePixels = 1.5f;
    private const float LineSoftEdgeAlpha = 0.4f;
    private const float EraserRadiusPixels = 6f;
    private const float LabelYOffset = 6f;
    private const float LabelStackOffset = 9f;
    private const float LabelMinFontSize = 7f;
    private const float LabelFontScale = 9f;
    private const float LabelPadding = 2f;
    private const float MinZoom = 0.3f;
    private const float MaxZoom = 5.0f;
    private const float ZoomSpeed = 1.2f;
    private const float LabelClickTolerance = 15f;

    private const float PingDuration = 2.0f;
    private const float PingMinScale = 1.0f;
    private const float PingMaxScale = 2.5f;
    private const float PingMinAlpha = 0.0f;
    private const float PingMaxAlpha = 0.65f;
    private const float PingRingThickness = 1.5f;

    private static readonly Color AreaLabelColor = Color.White;
    private static readonly Color DefaultTacticalLabelColor = Color.White;
    private static readonly Color AreaLabelBackground = Color.Black.WithAlpha(0.5f);
    private static readonly Color TacticalLabelBackground = Color.FromHex("#0D1A2F").WithAlpha(0.5f);
    private static readonly Color LabelDragBackground = Color.Black.WithAlpha(0.7f);
    private static readonly Color EraserPreviewColor = Color.White.WithAlpha(0.45f);

    [Dependency] private readonly IEntitySystemManager _entitySystemManager = default!;
    [Dependency] private readonly IResourceCache _resourceCache = default!;

    private readonly Font _font;
    private readonly Label? _tunnelInfoLabel;
    private readonly Vector2[] _reusableLineVectors = new Vector2[6];

    public readonly List<TacticalMapLine> Lines = new();
    public readonly List<float> LineThicknesses = new();
    public readonly Dictionary<Vector2i, TacticalMapLabelData> TacticalLabels = new();

    private TacticalMapBlip[]? _blips;
    private int[]? _blipEntityIds;
    private int? _localPlayerEntityId;
    private Dictionary<Vector2i, string> _areaLabels = new();
    private bool[]? _tileMask;
    private Texture? _backgroundTexture;
    private int _tileMaskWidth;
    private int _tileMaskHeight;

    private Vector2i _min;
    private Vector2i _delta;
    private float _zoomFactor = 1.0f;
    private Vector2 _panOffset = Vector2.Zero;

    private bool _dragging;
    private Vector2i? _lastDrag;
    private Vector2i? _dragStart;
    private Vector2i? _previewEnd;
    private bool _rightClickPanning;
    private Vector2? _lastPanPosition;
    private Vector2? _rightClickStartPosition;
    private bool _rightClickMoved;
    private Vector2? _lastErasePosition;

    private Vector2i? _draggingLabel;
    private Vector2i? _labelDragStart;
    private Vector2? _currentDragPosition;
    private Vector2? _lastMousePosition;
    private Vector2i? _lastHoverIndices;

    private EntityUid? _currentMapEntity;
    private string? _currentMapName;
    private EntityUid? _currentAreaGridEntity;

    private Action<float, Vector2>? _viewUpdateCallback;

    public int LineLimit;
    public bool Drawing { get; set; }
    public bool IsCanvas { get; set; } = false;
    public LabelMode CurrentLabelMode { get; set; } = LabelMode.All;
    public bool StraightLineMode { get; set; } = false;
    public bool LabelEditMode { get; set; } = false;
    public bool EraserMode { get; set; } = false;
    public Color Color;
    public float BlipSizeMultiplier { get; set; } = 0.9f;
    public float LineThickness { get; set; } = 2.0f;
    public bool QueenEyeMode { get; set; }

    public Action<Vector2i>? OnBlipClicked;
    public Action<Vector2i, string>? OnBlipRightClicked;
    public Action<TacticalMapControl, Vector2i, Vector2>? OnContextMenuRequested;
    public Action? OnUserInteraction;
    public Action<Vector2i>? OnQueenEyeMove;
    public Action<Vector2i, string>? OnCreateLabel;
    public Action<Vector2i, string>? OnEditLabel;
    public Action<Vector2i>? OnDeleteLabel;
    public Action<Vector2i, Vector2i>? OnMoveLabel;
    public Action<TacticalMapAreaInfo?>? OnHoverAreaInfo;

    public TacticalMapControl()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
        _font = new VectorFont(_resourceCache.GetResource<FontResource>("/Fonts/NotoSans/NotoSans-Bold.ttf"), 10);

        _tunnelInfoLabel = new Label
        {
            Visible = false,
            StyleClasses = { "LabelHeading" },
            FontColorOverride = Color.Black,
            Margin = new Thickness(8, 8),
            HorizontalAlignment = HAlignment.Center,
            VerticalAlignment = VAlignment.Center,
        };

        AddChild(_tunnelInfoLabel);
    }
}

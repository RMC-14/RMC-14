using Content.Shared._RMC14.Chemistry.ChemMaster;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client._RMC14.Chemistry.Master;

[GenerateTypedNameReferences]
public sealed partial class RMCChemMasterPresetWindow : DefaultWindow
{
    private int? _selectedQuickAccessSlot;
    private readonly Dictionary<int, Button> _slotButtons = new();

    public RMCChemMasterPresetWindow()
    {
        RobustXamlLoader.Load(this);

        UsePresetNameAsLabelCheckbox.OnToggled += args =>
        {
            BottleLabelInput.Editable = !args.Pressed;
        };
    }

    public void InitializeQuickAccessSlots(int maxSlots)
    {
        QuickAccessSlotContainer.RemoveAllChildren();
        _slotButtons.Clear();

        for (var i = 1; i <= maxSlots; i++)
        {
            var slot = i;
            var button = new Button
            {
                Text = slot.ToString(),
                ToggleMode = true,
                MinWidth = 30,
                StyleClasses = { "OpenBoth" },
            };
            button.OnPressed += _ => ToggleQuickAccessSlot(slot);
            _slotButtons[slot] = button;
            QuickAccessSlotContainer.AddChild(button);
        }
    }

    private void ToggleQuickAccessSlot(int slot)
    {
        if (_selectedQuickAccessSlot == slot)
        {
            _selectedQuickAccessSlot = null;
            _slotButtons[slot].Pressed = false;
        }
        else
        {
            if (_selectedQuickAccessSlot != null && _slotButtons.TryGetValue(_selectedQuickAccessSlot.Value, out var oldButton))
                oldButton.Pressed = false;

            _selectedQuickAccessSlot = slot;
            _slotButtons[slot].Pressed = true;
        }

        QuickAccessLabelContainer.Visible = _selectedQuickAccessSlot != null;
    }

    private void SetQuickAccessSlot(int? slot)
    {
        foreach (var button in _slotButtons.Values)
        {
            button.Pressed = false;
        }

        _selectedQuickAccessSlot = slot;

        if (slot != null && _slotButtons.TryGetValue(slot.Value, out var selectedButton))
            selectedButton.Pressed = true;

        QuickAccessLabelContainer.Visible = slot != null;
    }

    public void SetUsePresetNameAsLabel(bool value)
    {
        UsePresetNameAsLabelCheckbox.Pressed = value;
        BottleLabelInput.Editable = !value;
    }

    public bool GetUsePresetNameAsLabel()
    {
        return UsePresetNameAsLabelCheckbox.Pressed;
    }

    public void UpdatePresetsList(IReadOnlyList<RMCChemMasterPreset> presets, Action<RMCChemMasterPreset> onLoad, Action<string> onDelete)
    {
        SavedPresetsContainer.RemoveAllChildren();
        NoPresetsLabel.Visible = presets.Count == 0;

        foreach (var preset in presets)
        {
            var row = new RMCChemMasterPresetRow();
            row.PresetNameLabel.Text = preset.Name;
            if (preset.QuickAccessSlot != null)
                row.PresetNameLabel.Text += $" [Q{preset.QuickAccessSlot}]";
            row.LoadButton.OnPressed += _ => onLoad(preset);
            row.DeleteButton.OnPressed += _ => onDelete(preset.Name);
            SavedPresetsContainer.AddChild(row);
        }
    }

    public void LoadPresetIntoEditor(RMCChemMasterPreset preset)
    {
        PresetNameInput.Text = preset.Name;
        BottleLabelInput.Text = preset.BottleLabel;
        SetUsePresetNameAsLabel(preset.UsePresetNameAsLabel);
        SetQuickAccessSlot(preset.QuickAccessSlot);
        QuickAccessLabelInput.Text = preset.QuickAccessLabel;
    }

    public RMCChemMasterPreset GetPresetFromEditor(RMCPillBottleColors bottleColor, uint pillType)
    {
        return new RMCChemMasterPreset
        {
            Name = PresetNameInput.Text,
            BottleLabel = BottleLabelInput.Text,
            BottleColor = bottleColor,
            PillType = pillType,
            UsePresetNameAsLabel = GetUsePresetNameAsLabel(),
            QuickAccessSlot = _selectedQuickAccessSlot,
            QuickAccessLabel = QuickAccessLabelInput.Text,
        };
    }

    public void ClearEditor()
    {
        PresetNameInput.Text = string.Empty;
        BottleLabelInput.Text = string.Empty;
        SetUsePresetNameAsLabel(false);
        SetQuickAccessSlot(null);
        QuickAccessLabelInput.Text = string.Empty;
    }
}

using Content.Client.UserInterface.Controls;
using Content.Shared._RMC14.CCVar;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Configuration;
using Robust.Shared.Timing;
using Robust.Shared.Utility;

namespace Content.Client._RMC14.NewPlayer;

[GenerateTypedNameReferences]
public sealed partial class NewToJobPopup : FancyWindow
{
    [Dependency] private readonly IConfigurationManager _cfg = default!;

    private float _remainingTime;
    private bool _initialSkipState;

    public NewToJobPopup()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        InitializeUI();
        InitializeEvents();
        ResetTimer();
    }

    public void SetJobInfo(string? info,  string name)
    {
        if (string.IsNullOrWhiteSpace(info))
            return;

        NewToJobName.SetMessage(Loc.GetString("rmc-new-to-job-popup-job-name", ("name", Loc.GetString(name))));
        NewToJobLabel.SetMessage(Loc.GetString(info));
        NewToJobAdditional.SetMessage(FormattedMessage.FromMarkupOrThrow(Loc.GetString("rmc-new-to-job-additional")));
    }

    private void InitializeUI()
    {
        NewToJobCloseButton.Disabled = true;

        UpdateCloseButtonText();
    }

    private void InitializeEvents()
    {
        NewToJobCloseButton.OnPressed += OnClosePressed;
    }

    private void ResetTimer()
    {
        _remainingTime = _cfg.GetCVar(RMCCVars.RMCNewToJobPopupTime); // Set how long to show the popup for
        UpdateCloseButtonText();
    }

    private void OnClosePressed(BaseButton.ButtonEventArgs args)
    {
        Close();
    }

    private void UpdateCloseButtonText()
    {
        var isWaiting = _remainingTime > 0f;
        NewToJobCloseButton.Text = isWaiting
            ? Loc.GetString("rmc-new-to-job-popup-close-button-wait", ("time", (int)MathF.Ceiling(_remainingTime)))
            : Loc.GetString("rmc-new-to-job-popup-close-button");
        NewToJobCloseButton.Disabled = isWaiting;
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        if (!NewToJobCloseButton.Disabled)
            return;

        _remainingTime = MathF.Max(0f, _remainingTime - args.DeltaSeconds);
        UpdateCloseButtonText();
    }
}

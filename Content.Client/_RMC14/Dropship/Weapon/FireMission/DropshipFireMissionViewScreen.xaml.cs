using System.Linq;
using System.Numerics;
using Content.Client.Message;
using Content.Shared._RMC14.Dropship.Weapon;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client._RMC14.Dropship.Weapon.FireMission;

[GenerateTypedNameReferences]
public sealed partial class DropshipFireMissionViewScreen : PanelContainer
{
    public DropshipFireMissionViewScreen()
    {
        RobustXamlLoader.Load(this);
    }

    public void SetData(FireMissionData fireMission, List<WeaponDisplayInfo> weapons, int minTiming, int maxDuration)
    {
        FireMissionGrid.Columns = weapons.Count + 1;
        FireMissionGrid.RemoveAllChildren();

        FireMissionTitle.SetMarkupPermissive($"[color=#00FF36]Firemission: {fireMission.Name}[/color]");
        AddRow("Weapon", weapons.Select(w => w.Name).ToList());
        AddRow("Ammunition", weapons.Select(w => $"{w.Ammo} / {w.MaxAmmo}").ToList());
        AddRow("Consumption", weapons.Select(w => w.AmmoConsumption.ToString()).ToList());
        AddRow("", new List<string>(new string[weapons.Count]));

        for (var t = minTiming - 1; t < maxDuration; t++)
        {
            var weaponTexts = new List<string>();

            foreach (var weapon in weapons)
            {
                var text = "-";

                foreach (var offset in weapon.Offsets)
                {
                    if (offset.Row != t)
                        continue;

                    if (offset.Offset.HasValue)
                        text = offset.Offset.Value.ToString();

                    break;
                }

                weaponTexts.Add(text);
            }

            AddRow((t + 1).ToString(), weaponTexts);
        }
    }

    private void AddRow(string infoText, List<string> weaponTexts)
    {
        var infoLabel = new RichTextLabel
        {
            Text = $"[color=#00FF36]{infoText}[/color]",
            HorizontalAlignment = HAlignment.Right,
            MinSize = new Vector2(100, 18),
        };
        FireMissionGrid.AddChild(infoLabel);

        for (var i = 0; i < weaponTexts.Count; i++)
        {
            FireMissionGrid.AddChild(new RichTextLabel
            {
                Text = $"[color=#00FF36]{weaponTexts[i]}[/color]",
                HorizontalAlignment = HAlignment.Center,
                HorizontalExpand = true,
            });
        }
    }
}

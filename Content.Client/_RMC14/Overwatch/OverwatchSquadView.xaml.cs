using Content.Client._RMC14.UserInterface;
using Content.Client.UserInterface.ControlExtensions;
using Content.Shared._RMC14.Overwatch;
using Content.Shared.Mobs;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Input;
using Robust.Shared.Timing;
using static Robust.Client.UserInterface.Controls.BaseButton;

namespace Content.Client._RMC14.Overwatch;

[GenerateTypedNameReferences]
public sealed partial class OverwatchSquadView : Control
{
    public event Action? OnStop;
    public readonly FloatSpinBox Longitude;
    public readonly FloatSpinBox Latitude;
    public readonly FloatSpinBox OrbitalLongitude;
    public readonly FloatSpinBox OrbitalLatitude;
    public bool HasCrate;
    public bool HasOrbital;
    public TimeSpan NextLaunchAt;

    public OverwatchSquadView()
    {
        RobustXamlLoader.Load(this);

        TabContainer.SetTabTitle(SquadMonitor, "Squad Monitor");
        TabContainer.SetTabTitle(SupplyDrop, "Supply Drop");
        TabContainer.SetTabTitle(OrbitalBombardment, "Orbital Bombardment");

        Longitude = UIExtensions.CreateDialSpinBox(buttons: false, minWidth: 100);
        LongitudeContainer.AddChild(Longitude);
        Longitude.SetPositionFirst();

        Latitude = UIExtensions.CreateDialSpinBox(buttons: false, minWidth: 100);
        LatitudeContainer.AddChild(Latitude);
        Latitude.SetPositionFirst();

        Longitude.OnKeyBindDown += args =>
        {
            if (args.Function == EngineKeyFunctions.GuiTabNavigateNext ||
                args.Function == EngineKeyFunctions.GuiTabNavigatePrev)
            {
                Latitude.GrabKeyboardFocus();
            }
        };

        Latitude.OnKeyBindDown += args =>
        {
            if (args.Function == EngineKeyFunctions.GuiTabNavigateNext ||
                args.Function == EngineKeyFunctions.GuiTabNavigatePrev)
            {
                Longitude.GrabKeyboardFocus();
            }
        };

        OrbitalLongitude = UIExtensions.CreateDialSpinBox(buttons: false, minWidth: 100);
        OrbitalLongitudeContainer.AddChild(OrbitalLongitude);
        OrbitalLongitude.SetPositionFirst();

        OrbitalLatitude = UIExtensions.CreateDialSpinBox(buttons: false, minWidth: 100);
        OrbitalLatitudeContainer.AddChild(OrbitalLatitude);
        OrbitalLatitude.SetPositionFirst();

        OrbitalLongitude.OnKeyBindDown += args =>
        {
            if (args.Function == EngineKeyFunctions.GuiTabNavigateNext ||
                args.Function == EngineKeyFunctions.GuiTabNavigatePrev)
            {
                OrbitalLatitude.GrabKeyboardFocus();
            }
        };

        OrbitalLatitude.OnKeyBindDown += args =>
        {
            if (args.Function == EngineKeyFunctions.GuiTabNavigateNext ||
                args.Function == EngineKeyFunctions.GuiTabNavigatePrev)
            {
                OrbitalLongitude.GrabKeyboardFocus();
            }
        };

        StopOverwatchButton.OnPressed += OnStopOverwatchPressed;
        LaunchButton.Label.ModulateSelfOverride = Color.Black;
        SaveButton.Label.ModulateSelfOverride = Color.Black;
        OrbitalSaveButton.Label.ModulateSelfOverride = Color.Black;
    }

    private void OnStopOverwatchPressed(ButtonEventArgs obj)
    {
        OnStop?.Invoke();
    }

    private void MakeAllVisible(Control control)
    {
        foreach (var child in control.Children)
        {
            child.Visible = true;
        }
    }

    private void MakeAllVisible()
    {
        MakeAllVisible(Names);
        MakeAllVisible(Roles);
        MakeAllVisible(States);
        MakeAllVisible(Locations);
        MakeAllVisible(Distances);
        MakeAllVisible(Buttons);
    }

    private void MakeControlVisible(Control control, int index, bool visible)
    {
        if (index >= control.ChildCount)
            return;

        control.GetChild(index).Visible = visible;
    }

    private void MakeViewVisible(int index, bool visible)
    {
        MakeControlVisible(Names, index, visible);
        MakeControlVisible(Roles, index, visible);
        MakeControlVisible(States, index, visible);
        MakeControlVisible(Locations, index, visible);
        MakeControlVisible(Distances, index, visible);
        MakeControlVisible(Buttons, index, visible);
    }

    public void UpdateResults(OverwatchLocation? location, bool showDead, bool showHidden, List<OverwatchMarine> marines, OverwatchConsoleComponent console)
    {
        var text = SearchBar.Text;
        if (string.IsNullOrWhiteSpace(text) &&
            location == null &&
            showDead &&
            showHidden)
        {
            MakeAllVisible();
            return;
        }

        for (var i = 0; i < Names.ChildCount; i++)
        {
            var name = Names.GetChild(i);
            var role = Roles.GetChild(i);
            if (!string.IsNullOrWhiteSpace(text))
            {
                if (!name.ChildrenContainText(text) && !role.ChildrenContainText(text))
                {
                    MakeViewVisible(i, false);
                    continue;
                }
            }

            if (location != null)
            {
                if (i >= marines.Count || marines[i].Location != location)
                {
                    MakeViewVisible(i, false);
                    continue;
                }
            }

            if (!showDead)
            {
                if (i >= marines.Count || marines[i].State != MobState.Alive)
                {
                    MakeViewVisible(i, false);
                    continue;
                }
            }

            if (!showHidden)
            {
                var hidden = console.Hidden;
                if (i >= marines.Count || hidden.Contains(marines[i].Id))
                {
                    MakeViewVisible(i, false);
                    continue;
                }
            }

            MakeViewVisible(i, true);
        }
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        CrateStatus.Text = HasCrate
            ? "[color=green][bold]Crate Loaded[/bold][/color]"
            : "[color=red][bold]No crate loaded[/bold][/color]";

        var time = IoCManager.Resolve<IGameTiming>().CurTime;
        var timeLeft = NextLaunchAt - time;
        if (timeLeft > TimeSpan.Zero)
        {
            CrateStatus.Text = $"[color=#D3B400][bold]Cooldown - {(int)timeLeft.TotalSeconds} seconds[/bold][/color]";
            LaunchButton.Disabled = true;
        }
        else
        {
            LaunchButton.Disabled = false;
        }

        OrbitalStatus.Text = HasOrbital
            ? "[color=green][bold]Ready[/bold][/color]"
            : "[color=red][bold]Not ready[/bold][/color]";
    }
}

using Content.Shared._RMC14.Medical.MedicalPods;
using Content.Shared.Temperature;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client._RMC14.Medical.MedicalPods;

[GenerateTypedNameReferences]
public sealed partial class SleeperConsoleWindow : DefaultWindow
{
    private SleeperConsoleBui? _bui;

    public SleeperConsoleWindow()
    {
        RobustXamlLoader.Load(this);

        DialysisToggleButton.OnPressed += _ => _bui?.ToggleFilter();
        EjectButton.OnPressed += _ => _bui?.Eject();
        AutoEjectDeadButton.OnPressed += _ =>
        {
            _bui?.SetAutoEjectDead(AutoEjectDeadButton.Pressed);
        };
    }

    public void SetBui(SleeperConsoleBui bui)
    {
        _bui = bui;
    }

    public void UpdateState(SleeperBuiState state)
    {
        var hasOccupant = state.Occupant != null;
        EmptyPanel.Visible = !hasOccupant;
        OccupantPanel.Visible = hasOccupant;

        if (!hasOccupant)
            return;

        // Dialysis
        DialysisToggleButton.Pressed = state.Filtering;
        DialysisToggleButton.Text = state.Filtering
            ? Loc.GetString("rmc-sleeper-dialysis-active")
            : Loc.GetString("rmc-sleeper-dialysis-inactive");

        if (state.Filtering && state.ReagentsWhenStarted > 0)
        {
            DialysisProgressContainer.Visible = true;
            DialysisProgressBar.Value = (state.TotalReagents / state.ReagentsWhenStarted).Float();
            DialysisProgressLabel.Text = $"{state.TotalReagents:F2}/{state.ReagentsWhenStarted:F2}";
            DialysisStatusContainer.Visible = false;
        }
        else
        {
            DialysisProgressContainer.Visible = false;
            if (state.TotalReagents <= 0)
            {
                DialysisStatusContainer.Visible = true;
                DialysisStatusLabel.Text = Loc.GetString("rmc-sleeper-dialysis-no-chemicals");
            }
            else
            {
                DialysisStatusContainer.Visible = true;
                DialysisStatusLabel.Text = Loc.GetString("rmc-sleeper-dialysis-ready");
            }
        }

        // Auto-eject
        AutoEjectDeadButton.Pressed = state.AutoEjectDead;
        AutoEjectDeadButton.Text = state.AutoEjectDead
            ? Loc.GetString("rmc-sleeper-auto-eject-dead-on")
            : Loc.GetString("rmc-sleeper-auto-eject-dead-off");

        OccupantNameLabel.Text = state.OccupantName ?? "";

        // Health
        HealthBar.Value = state.Health;
        HealthBar.MaxValue = state.MaxHealth;
        HealthBar.MinValue = 0;
        HealthBarText.Text = $"{state.Health:F0}";

        var crisisDamageThreshold = state.MaxHealth - state.CrisisMinDamage;
        HealthBar.ForegroundStyleBoxOverride = state.Health switch
        {
            _ when state.Health >= crisisDamageThreshold => new StyleBoxFlat(Color.FromHex("#408040")),
            >= 0 => new StyleBoxFlat(Color.FromHex("#FFFF00")),
            _ => new StyleBoxFlat(Color.FromHex("#FF0000"))
        };
        StatusLabel.Text = state.OccupantState switch
        {
            SleeperOccupantMobState.Alive => Loc.GetString("rmc-sleeper-status-alive"),
            SleeperOccupantMobState.Critical => Loc.GetString("rmc-sleeper-status-critical"),
            SleeperOccupantMobState.Dead => Loc.GetString("rmc-sleeper-status-dead"),
            _ => ""
        };
        StatusLabel.Modulate = state.OccupantState switch
        {
            SleeperOccupantMobState.Alive => Color.FromHex("#00FF00"),
            SleeperOccupantMobState.Critical => Color.FromHex("#FFFF00"),
            SleeperOccupantMobState.Dead => Color.FromHex("#FF0000"),
            _ => Color.White
        };

        var tempCelsius = TemperatureHelpers.KelvinToCelsius(state.BodyTemperature);
        var tempFahrenheit = TemperatureHelpers.KelvinToFahrenheit(state.BodyTemperature);
        TemperatureBar.Value = state.BodyTemperature;
        TemperatureBar.MaxValue = 1000; // Kelvin
        TemperatureBarText.Text = $"{tempCelsius:F0}°C, {tempFahrenheit:F0}°F";

        TemperatureBar.ForegroundStyleBoxOverride = state.TemperatureSuitability switch
        {
            -3 => new StyleBoxFlat(Color.FromHex("#0000AA")),
            -2 => new StyleBoxFlat(Color.FromHex("#0066FF")),
            -1 => new StyleBoxFlat(Color.FromHex("#66CCFF")),
            0 => new StyleBoxFlat(Color.FromHex("#408040")),
            1 => new StyleBoxFlat(Color.FromHex("#FFFF00")),
            2 => new StyleBoxFlat(Color.FromHex("#FF8800")),
            3 => new StyleBoxFlat(Color.FromHex("#FF0000")),
            _ => new StyleBoxFlat(Color.FromHex("#408040"))
        };

        // Blood level
        BloodSection.Visible = state.HasBlood;
        if (state.HasBlood)
        {
            BloodBar.Value = state.BloodPercent;
            BloodBar.MaxValue = 100;
            BloodBar.MinValue = 0;
            BloodBarText.Text = $"{state.BloodPercent:F2}%, {state.BloodLevel}cl";

            BloodBar.ForegroundStyleBoxOverride = state.BloodPercent switch
            {
                >= 90 => new StyleBoxFlat(Color.FromHex("#408040")),
                >= 60 => new StyleBoxFlat(Color.FromHex("#FFFF00")),
                _ => new StyleBoxFlat(Color.FromHex("#FF0000"))
            };

            PulseLabel.Text = state.Pulse switch
            {
                0 => Loc.GetString("rmc-pulse-bpm", ("value", 0)),
                >= 250 => Loc.GetString("rmc-pulse-thready-machine"),
                _ => Loc.GetString("rmc-pulse-bpm", ("value", state.Pulse))
            };
        }

        // Damage bars
        UpdateDamageBar(BruteBar, BruteBarText, state.BruteLoss);
        UpdateDamageBar(BurnBar, BurnBarText, state.BurnLoss);
        UpdateDamageBar(ToxinBar, ToxinBarText, state.ToxinLoss);
        UpdateDamageBar(OxygenBar, OxygenBarText, state.OxyLoss);

        GeneticSection.Visible = state.GeneticLoss > 0;
        if (state.GeneticLoss > 0)
        {
            UpdateDamageBar(GeneticBar, GeneticBarText, state.GeneticLoss);
        }

        // Chemicals
        ChemicalsContainer.DisposeAllChildren();
        foreach (var (name, chemId, occupantAmount, injectable, overdosing, odWarning) in state.Chemicals)
        {
            var row = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Horizontal,
                Margin = new Thickness(0, 2, 0, 2)
            };

            var nameLabel = new Label
            {
                Text = name,
                MinWidth = 120
            };
            row.AddChild(nameLabel);

            var amountBar = new ProgressBar
            {
                HorizontalExpand = true,
                MinHeight = 16,
                Value = occupantAmount.Float(),
                MaxValue = state.MaxChem.Float()
            };

            var amountLabel = new Label
            {
                Text = $"{occupantAmount}/{state.MaxChem}u",
                Align = Label.AlignMode.Right,
                FontColorOverride = Color.White
            };
            amountBar.AddChild(amountLabel);

            if (overdosing)
            {
                amountBar.ForegroundStyleBoxOverride = new StyleBoxFlat(Color.FromHex("#FF0000"));
            }
            else if (odWarning)
            {
                amountBar.ForegroundStyleBoxOverride = new StyleBoxFlat(Color.FromHex("#FFFF00"));
            }
            row.AddChild(amountBar);

            foreach (var amount in state.InjectionAmounts)
            {
                var injectButton = new Button
                {
                    Text = Loc.GetString("rmc-sleeper-inject", ("amount", amount)),
                    Disabled = !injectable || occupantAmount + amount > state.MaxChem || state.OccupantState == SleeperOccupantMobState.Dead,
                    Margin = new Thickness(5, 0, 0, 0)
                };
                var injectAmount = amount;
                injectButton.OnPressed += _ => _bui?.InjectChemical(chemId, injectAmount);
                row.AddChild(injectButton);
            }

            ChemicalsContainer.AddChild(row);
        }
    }

    private static void UpdateDamageBar(ProgressBar bar, Label label, float damage)
    {
        bar.Value = damage;
        label.Text = damage.ToString("F0");

        bar.ForegroundStyleBoxOverride = damage switch
        {
            < 25 => new StyleBoxFlat(Color.FromHex("#408040")),
            < 50 => new StyleBoxFlat(Color.FromHex("#FFFF00")),
            _ => new StyleBoxFlat(Color.FromHex("#FF0000"))
        };
    }
}

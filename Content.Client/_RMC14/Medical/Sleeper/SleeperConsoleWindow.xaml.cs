using Content.Shared._RMC14.Medical.Sleeper;
using Content.Shared._RMC14.Mobs;
using Content.Shared.Chemistry.Reagent;
using Content.Shared.Temperature;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client._RMC14.Medical.Sleeper;

[GenerateTypedNameReferences]
public sealed partial class SleeperConsoleWindow : DefaultWindow
{
    private SleeperConsoleBui? _bui;

    /// <summary>
    /// Cache of chemical row UI elements keyed by reagent ID.
    /// Used to avoid recreating UI elements on every state update. This would cause button click events to be missed when updates occur.
    /// </summary>
    private readonly Dictionary<ProtoId<ReagentPrototype>, ChemicalRowControls> _chemicalRows = new();

    public SleeperConsoleWindow()
    {
        RobustXamlLoader.Load(this);

        DialysisToggleButton.OnPressed += _ => _bui?.ToggleFilter();
        EjectButton.OnPressed += _ => _bui?.Eject();
        AutoEjectDeadButton.OnPressed += _ =>
        {
            _bui?.SetAutoEjectDead(AutoEjectDeadButton.Pressed);
        };
    }

    public void SetBui(SleeperConsoleBui bui)
    {
        _bui = bui;
    }

    public void UpdateState(SleeperBuiState state)
    {
        var hasOccupant = state.Occupant != null;
        EmptyPanel.Visible = !hasOccupant;
        OccupantPanel.Visible = hasOccupant;

        if (!hasOccupant)
        {
            ClearChemicalRows();
            return;
        }

        // Dialysis
        DialysisToggleButton.Pressed = state.Filtering;
        DialysisToggleButton.Text = state.Filtering
            ? Loc.GetString("rmc-sleeper-dialysis-active")
            : Loc.GetString("rmc-sleeper-dialysis-inactive");

        if (state.Filtering && state.ReagentsWhenStarted > 0)
        {
            DialysisProgressContainer.Visible = true;
            DialysisProgressBar.Value = (state.TotalReagents / state.ReagentsWhenStarted).Float();
            DialysisProgressLabel.Text = $"{state.TotalReagents:F2}/{state.ReagentsWhenStarted:F2}";
            DialysisStatusContainer.Visible = false;
        }
        else
        {
            DialysisProgressContainer.Visible = false;
            if (state.TotalReagents <= 0)
            {
                DialysisStatusContainer.Visible = true;
                DialysisStatusLabel.Text = Loc.GetString("rmc-sleeper-dialysis-no-chemicals");
            }
            else
            {
                DialysisStatusContainer.Visible = true;
                DialysisStatusLabel.Text = Loc.GetString("rmc-sleeper-dialysis-ready");
            }
        }

        // Auto-eject
        AutoEjectDeadButton.Pressed = state.AutoEjectDead;
        AutoEjectDeadButton.Text = state.AutoEjectDead
            ? Loc.GetString("rmc-sleeper-auto-eject-dead-on")
            : Loc.GetString("rmc-sleeper-auto-eject-dead-off");

        OccupantNameLabel.Text = state.OccupantName ?? "";

        // Health
        HealthBar.Value = state.Health;
        HealthBar.MaxValue = state.MaxHealth;
        HealthBar.MinValue = 0;
        HealthBarText.Text = $"{state.Health:F0}";

        HealthBar.ForegroundStyleBoxOverride = state.Health switch
        {
            _ when state.Health >= state.EmergencyHealthThreshold => new StyleBoxFlat(Color.FromHex("#408040")),
            >= 0 => new StyleBoxFlat(Color.FromHex("#A0A030")),
            _ => new StyleBoxFlat(Color.FromHex("#A04040"))
        };
        StatusLabel.Text = state.OccupantState switch
        {
            SleeperOccupantMobState.Alive => Loc.GetString("rmc-sleeper-status-alive"),
            SleeperOccupantMobState.Critical => Loc.GetString("rmc-sleeper-status-critical"),
            SleeperOccupantMobState.Dead => Loc.GetString("rmc-sleeper-status-dead"),
            _ => ""
        };
        StatusLabel.Modulate = state.OccupantState switch
        {
            SleeperOccupantMobState.Alive => Color.FromHex("#00FF00"),
            SleeperOccupantMobState.Critical => Color.FromHex("#FFFF00"),
            SleeperOccupantMobState.Dead => Color.FromHex("#FF0000"),
            _ => Color.White
        };

        var tempCelsius = TemperatureHelpers.KelvinToCelsius(state.BodyTemperature);
        var tempFahrenheit = TemperatureHelpers.KelvinToFahrenheit(state.BodyTemperature);
        TemperatureBar.Value = state.BodyTemperature;
        TemperatureBarText.Text = $"{tempCelsius:F0}°C, {tempFahrenheit:F0}°F";

        TemperatureBar.ForegroundStyleBoxOverride = state.BodyTemperature switch
        {
            // TODO RMC14 RMCTemperatureSystem Component HeatLevel 1-3 ColdLevel 1-3 (in Kelvin)
            <= 120f => new StyleBoxFlat(Color.FromHex("#0000AA")),
            <= 240f => new StyleBoxFlat(Color.FromHex("#0066FF")),
            <= 260.15f => new StyleBoxFlat(Color.FromHex("#66CCFF")),
            >= 800f => new StyleBoxFlat(Color.FromHex("#FF0000")),
            >= 400f => new StyleBoxFlat(Color.FromHex("#FF8800")),
            >= 373.15f => new StyleBoxFlat(Color.FromHex("#FFFF00")),
            _ => new StyleBoxFlat(Color.FromHex("#408040"))
        };

        // Blood level
        BloodSection.Visible = state.HasBlood;
        if (state.HasBlood)
        {
            BloodBar.Value = state.BloodPercent;
            BloodBarText.Text = $"{state.BloodPercent:F2}%, {state.BloodLevel}cl";

            BloodBar.ForegroundStyleBoxOverride = state.BloodPercent switch
            {
                >= 90 => new StyleBoxFlat(Color.FromHex("#408040")),
                >= 60 => new StyleBoxFlat(Color.FromHex("#A0A030")),
                _ => new StyleBoxFlat(Color.FromHex("#A04040"))
            };

            PulseLabel.Text = RMCPulseSystem.GetPulseLocalizedDisplayString(state.Pulse, true);
        }

        // Damage bars
        UpdateDamageBar(BruteBar, BruteBarText, state.BruteLoss);
        UpdateDamageBar(BurnBar, BurnBarText, state.BurnLoss);
        UpdateDamageBar(ToxinBar, ToxinBarText, state.ToxinLoss);
        UpdateDamageBar(OxygenBar, OxygenBarText, state.OxyLoss);

        GeneticSection.Visible = state.GeneticLoss > 0;
        if (state.GeneticLoss > 0)
        {
            UpdateDamageBar(GeneticBar, GeneticBarText, state.GeneticLoss);
        }

        UpdateChemicalRows(state);
    }

    private static void UpdateDamageBar(ProgressBar bar, Label label, float damage)
    {
        bar.Value = damage;
        label.Text = damage.ToString("F0");

        bar.ForegroundStyleBoxOverride = damage switch
        {
            < 25 => new StyleBoxFlat(Color.FromHex("#408040")),
            < 50 => new StyleBoxFlat(Color.FromHex("#A0A030")),
            _ => new StyleBoxFlat(Color.FromHex("#A04040"))
        };
    }

    private void ClearChemicalRows()
    {
        foreach (var row in _chemicalRows.Values)
        {
            ChemicalsContainer.RemoveChild(row.Row);
        }
        _chemicalRows.Clear();
    }

    private void UpdateChemicalRows(SleeperBuiState state)
    {
        // Track which chemicals are in the current state
        var currentChemicals = new HashSet<ProtoId<ReagentPrototype>>();
        foreach (var (name, chemId, occupantAmount, injectable, overdosing, odWarning) in state.Chemicals)
        {
            currentChemicals.Add(chemId);

            if (_chemicalRows.TryGetValue(chemId, out var existingRow))
            {
                // Update existing row - preserve button instances to maintain click handlers
                existingRow.NameLabel.Text = name;
                existingRow.AmountBar.Value = occupantAmount.Float();
                existingRow.AmountBar.MaxValue = state.MaxChem.Float();
                existingRow.AmountLabel.Text = $"{occupantAmount}/{state.MaxChem}u";

                // Update progress bar color
                if (overdosing)
                    existingRow.AmountBar.ForegroundStyleBoxOverride = new StyleBoxFlat(Color.FromHex("#A04040"));
                else if (odWarning)
                    existingRow.AmountBar.ForegroundStyleBoxOverride = new StyleBoxFlat(Color.FromHex("#A0A030"));
                else
                    existingRow.AmountBar.ForegroundStyleBoxOverride = null;

                // Update button disabled states without recreating buttons
                for (var i = 0; i < existingRow.InjectButtons.Count && i < state.InjectionAmounts.Length; i++)
                {
                    var amount = state.InjectionAmounts[i];
                    existingRow.InjectButtons[i].Disabled = !injectable ||
                        occupantAmount + amount > state.MaxChem ||
                        state.OccupantState == SleeperOccupantMobState.Dead;
                }
            }
            else
            {
                var row = new BoxContainer
                {
                    Orientation = BoxContainer.LayoutOrientation.Horizontal,
                    Margin = new Thickness(0, 2, 0, 2)
                };

                var nameLabel = new Label
                {
                    Text = name,
                    MinWidth = 120
                };
                row.AddChild(nameLabel);

                var amountBar = new ProgressBar
                {
                    HorizontalExpand = true,
                    MinHeight = 16,
                    Value = occupantAmount.Float(),
                    MaxValue = state.MaxChem.Float()
                };

                var amountLabel = new Label
                {
                    Text = $"{occupantAmount}/{state.MaxChem}u",
                    Align = Label.AlignMode.Right,
                    Margin = new Thickness(0, 0, 5, 0)
                };
                amountBar.AddChild(amountLabel);

                if (overdosing)
                    amountBar.ForegroundStyleBoxOverride = new StyleBoxFlat(Color.FromHex("#A04040"));
                else if (odWarning)
                    amountBar.ForegroundStyleBoxOverride = new StyleBoxFlat(Color.FromHex("#A0A030"));

                row.AddChild(amountBar);

                var injectButtons = new List<Button>();
                foreach (var amount in state.InjectionAmounts)
                {
                    var injectButton = new Button
                    {
                        Text = Loc.GetString("rmc-sleeper-inject", ("amount", amount)),
                        Disabled = !injectable || occupantAmount + amount > state.MaxChem || state.OccupantState == SleeperOccupantMobState.Dead,
                        Margin = new Thickness(5, 0, 0, 0)
                    };
                    var injectAmount = amount;
                    injectButton.OnPressed += _ => _bui?.InjectChemical(chemId, injectAmount);
                    row.AddChild(injectButton);
                    injectButtons.Add(injectButton);
                }

                ChemicalsContainer.AddChild(row);
                _chemicalRows[chemId] = new ChemicalRowControls(row, nameLabel, amountBar, amountLabel, injectButtons);
            }
        }

        var chemicalsToRemove = new List<ProtoId<ReagentPrototype>>();
        foreach (var chemId in _chemicalRows.Keys)
        {
            if (!currentChemicals.Contains(chemId))
                chemicalsToRemove.Add(chemId);
        }

        foreach (var chemId in chemicalsToRemove)
        {
            if (_chemicalRows.TryGetValue(chemId, out var rowControls))
            {
                ChemicalsContainer.RemoveChild(rowControls.Row);
                _chemicalRows.Remove(chemId);
            }
        }
    }

    private sealed record ChemicalRowControls(
        BoxContainer Row,
        Label NameLabel,
        ProgressBar AmountBar,
        Label AmountLabel,
        List<Button> InjectButtons);
}

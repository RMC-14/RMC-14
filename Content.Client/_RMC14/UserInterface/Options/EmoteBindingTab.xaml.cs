using System.Linq;
using Content.Client.Options.UI;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Content.Shared.CCVar;
using Content.Shared._RMC14.CCVar;
using Content.Shared.Chat.Prototypes;
using Content.Shared.Speech.Components;
using Robust.Shared.Prototypes;

namespace Content.Client._RMC14.UserInterface.Options;

[GenerateTypedNameReferences]
public sealed partial class EmoteBindingTab : ScrollContainer
{
    [Dependency] private readonly IPrototypeManager _prototypeManager = default!;

    public List<OptionDropDownCVar<string>.ValueOption> HumanoidEmoteDropdownOptions = [];
    public List<OptionDropDownCVar<string>.ValueOption> XenoEmoteDropdownOptions = [];

    public EmoteBindingTab()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);
        UpdateDropdowns();
    }

    public void UpdateDropdowns()
    {
        // Get all emotes that are "spoken"
        var emoteProtos = _prototypeManager
            .EnumeratePrototypes<EmotePrototype>()
            .Where(emote => emote.Category == EmoteCategory.Vocal);

        // Filter emotes to Humanoid and Xeno lists
        HumanoidEmoteDropdownOptions.Add(new OptionDropDownCVar<string>.ValueOption(Loc.GetString("rmc-ui-emote-binding-none"), "None"));
        XenoEmoteDropdownOptions.Add(new OptionDropDownCVar<string>.ValueOption(Loc.GetString("rmc-ui-emote-binding-none"), "None"));
        foreach (var emoteProto in emoteProtos)
        {
            // Ensure whitelisting is enabled
            if (emoteProto.Whitelist == null || emoteProto.Whitelist.Components == null) {continue;}
            // Remove any that are whitelisted to Cyborgs
            if ((emoteProto.Whitelist.RequireAll == true && emoteProto.Whitelist.Tags!.Contains("SiliconEmotes"))) {continue;}

            // Filter by Species/Faction
            if (emoteProto.Whitelist.Components.Contains("Vocal"))
            {
                // Add disclaimer for any species specific Humanoid emotes
                var label = emoteProto.Available
                    ? Loc.GetString(emoteProto.Name)
                    : $"* {Loc.GetString(emoteProto.Name)}";
                HumanoidEmoteDropdownOptions.Add(
                    new OptionDropDownCVar<string>.ValueOption(emoteProto.ID, label)
                );
            }
            if (emoteProto.Whitelist.Components.Contains("Xeno"))
            {
                XenoEmoteDropdownOptions.Add(
                    new OptionDropDownCVar<string>.ValueOption(emoteProto.ID, Loc.GetString(emoteProto.Name))
                );
            }
        }

        // Add emotes to dropdowns
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingHumanoid1, DropDownHumanoidEmote1, HumanoidEmoteDropdownOptions);
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingHumanoid2, DropDownHumanoidEmote2, HumanoidEmoteDropdownOptions);
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingHumanoid3, DropDownHumanoidEmote3, HumanoidEmoteDropdownOptions);
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingHumanoid4, DropDownHumanoidEmote4, HumanoidEmoteDropdownOptions);
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingHumanoid5, DropDownHumanoidEmote5, HumanoidEmoteDropdownOptions);
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingHumanoid6, DropDownHumanoidEmote6, HumanoidEmoteDropdownOptions);
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingHumanoid7, DropDownHumanoidEmote7, HumanoidEmoteDropdownOptions);
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingHumanoid8, DropDownHumanoidEmote8, HumanoidEmoteDropdownOptions);

        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingXeno1, DropDownXenoEmote1, XenoEmoteDropdownOptions);
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingXeno2, DropDownXenoEmote2, XenoEmoteDropdownOptions);
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingXeno3, DropDownXenoEmote3, XenoEmoteDropdownOptions);
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingXeno4, DropDownXenoEmote4, XenoEmoteDropdownOptions);
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingXeno5, DropDownXenoEmote5, XenoEmoteDropdownOptions);
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingXeno6, DropDownXenoEmote6, XenoEmoteDropdownOptions);
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingXeno7, DropDownXenoEmote7, XenoEmoteDropdownOptions);
        Control.AddOptionDropDown(RMCCVars.RMCEmoteBindingXeno8, DropDownXenoEmote8, XenoEmoteDropdownOptions);

        Control.Initialize();
    }
}

using System.Linq;
using System.Numerics;
using Content.Shared.Ghost;
using Content.Shared.Roles;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;

namespace Content.Client.UserInterface.Systems.Ghost.Controls
{
    [GenerateTypedNameReferences]
    public sealed partial class GhostTargetWindow : DefaultWindow
    {
        private const string HeadingIndicatorCollapsed = "+";
        private const string HeadingIndicatorExpanded = "-";

        private record SortOption(string Label, string Tooltip, string TypeLabel);

        private sealed record SortOrderOption(
            string Label,
            string Tooltip,
            Func<IOrderedEnumerable<GhostWarp>, Func<GhostWarp, string>, IOrderedEnumerable<GhostWarp>> Apply)
            : SortOption(Label, Tooltip, "ghost-target-window-type-sort-dir-button");

        private record WarpCategory(
            string Label,
            Func<IEnumerable<GhostWarp>, IEnumerable<GhostWarp>> Filter,
            Func<GhostWarp, string> DisplayName,
            bool WarpsToEnd = true);

        private static readonly Comparer<string> OrdinalIgnoreCaseComparer =
            Comparer<string>.Create((x, y) => string.Compare(x, y, StringComparison.OrdinalIgnoreCase));

        private static readonly CaseInsensitiveComparer JobComparer = new();

        private readonly IPrototypeManager _prototypeManager;
        private readonly SortOrderOption[] _sortOrderOptions;
        private readonly List<(WarpCategory Category, BaseButton Button)> _categoryButtons = new();
        private readonly string[] _jobXenoTranslations;

        private List<GhostWarp> _warps = new();
        private string _searchText = string.Empty;
        private int _sortOrder;
        private WarpCategory? _selectedCategory;

        public event Action<NetEntity>? WarpClicked;
        public event Action? OnGhostnadoClicked;

        public GhostTargetWindow()
        {
            RobustXamlLoader.Load(this);
            SearchBar.OnTextChanged += OnSearchTextChanged;

            GhostnadoButton.OnPressed += _ => OnGhostnadoClicked?.Invoke();

            _prototypeManager = IoCManager.Resolve<IPrototypeManager>();

            _jobXenoTranslations = _prototypeManager.EnumeratePrototypes<JobPrototype>()
                .Where(j => j.Parents != null && j.Parents.Contains("CMJobXenoBase"))
                .Select(j => j.LocalizedName)
                .ToArray();

            _sortOrderOptions =
            [
                new("\u2191",
                    "ghost-target-window-type-sort-dir-asc-title",
                    (ordered, key) => ordered.ThenBy(key, OrdinalIgnoreCaseComparer)),
                new("\u2193",
                    "ghost-target-window-type-sort-dir-desc-title",
                    (ordered, key) => ordered.ThenByDescending(key, OrdinalIgnoreCaseComparer)),
            ];

            UpdateSortButtonAppearance();

            SortOrderButton.OnPressed += _ =>
            {
                _sortOrder = (_sortOrder + 1) % _sortOrderOptions.Length;
                UpdateSortButtonAppearance();
                Populate();
            };
        }

        private void UpdateSortButtonAppearance()
        {
            var option = _sortOrderOptions[_sortOrder];
            SortOrderButton.Text = option.Label;
            SortOrderButton.HideTooltip();
            var tooltip = new Tooltip();
            tooltip.SetMessage(FormattedMessage.FromUnformatted(
                Loc.GetString(option.TypeLabel, ("type", Loc.GetString(option.Tooltip)))));
            SortOrderButton.TooltipSupplier = _ => tooltip;
        }

        private static string PlayerDisplayName(GhostWarp w) =>
            w is PlayerGhostWarp { jobName.Length: > 0 } pw
                ? $"{pw.entityName} ({pw.jobName})"
                : w.entityName;

        private static string WarpPointDisplayName(GhostWarp w) =>
            Loc.GetString("ghost-target-window-current-button", ("name", w.entityName));

        private static string DefaultDisplayName(GhostWarp w) => w switch
        {
            PlayerGhostWarp => PlayerDisplayName(w),
            _ => WarpPointDisplayName(w),
        };

        private static bool JobEquals(string a, string b) =>
            string.Equals(a, b, StringComparison.OrdinalIgnoreCase);

        private bool IsXenoJob(string jobName) =>
            _jobXenoTranslations.Any(j => JobEquals(j, jobName));

        public void UpdateWarps(IEnumerable<GhostWarp> warps)
        {
            _warps = warps.ToList();
            Populate2();
            ResetSelectedCategory();
        }

        private void ResetSelectedCategory()
        {
            if (_selectedCategory == null || _categoryButtons.Any(cb => cb.Category.Label == _selectedCategory.Label))
            {
                return;
            }

            _selectedCategory = null;
        }

        public void Populate2()
        {
            _categoryButtons.Clear();
            CategoryContainer.DisposeAllChildren();

            var players = _warps.OfType<PlayerGhostWarp>().ToList();

            AddPlayerGroup(players, "ghost-target-window-type-filter-marines-title", p => !IsXenoJob(p.jobName));
            AddPlayerGroup(players, "ghost-target-window-type-filter-xeno-title", p => IsXenoJob(p.jobName));

            if (!_warps.Any(w => w.isWarpPoint))
                return;

            AddCategoryButton(new WarpCategory(
                "ghost-target-window-type-filter-warps-title",
                w => w.Where(e => e.isWarpPoint),
                WarpPointDisplayName,
                WarpsToEnd: false));
        }

        private void AddPlayerGroup(List<PlayerGhostWarp> players, string label, Func<PlayerGhostWarp, bool> predicate)
        {
            var jobs = players
                .Where(predicate)
                .Select(p => p.jobName)
                .Distinct(JobComparer)
                .OrderBy(j => j, OrdinalIgnoreCaseComparer)
                .ToArray();

            if (jobs.Length == 0)
                return;

            var category = new WarpCategory(
                label,
                w => w.Where(e => e is PlayerGhostWarp pgw && jobs.Any(j => JobEquals(j, pgw.jobName))),
                PlayerDisplayName);

            AddCollapsibleCategory(category, jobs);
        }

        private void SelectCategory(WarpCategory? category)
        {
            _selectedCategory = _selectedCategory?.Label == category?.Label ? null : category;
            UpdateCategorySelection();
            Populate();
        }

        private void UpdateCategorySelection()
        {
            foreach (var (cat, btn) in _categoryButtons)
            {
                if (btn is Button button)
                    button.Pressed = _selectedCategory?.Label == cat.Label;
            }
        }

        private Button CreateFilterButton(WarpCategory category, string text, bool pressed)
        {
            var button = new Button
            {
                Text = text,
                HorizontalExpand = true,
                TextAlign = Label.AlignMode.Left,
                ToggleMode = true,
                Pressed = pressed,
                ClipText = true,
                MaxWidth = 340,
            };
            button.OnPressed += _ => SelectCategory(category);
            _categoryButtons.Add((category, button));
            return button;
        }

        private void AddCategoryButton(WarpCategory category)
        {
            var selected = _selectedCategory?.Label == category.Label;
            var button = CreateFilterButton(category, Loc.GetString(category.Label), selected);
            CategoryContainer.AddChild(button);
        }

        private void AddCollapsibleCategory(WarpCategory category, string[] jobs)
        {
            var selected = _selectedCategory?.Label == category.Label;

            var heading = new CollapsibleHeading(Loc.GetString(category.Label));
            heading.HorizontalExpand = true;
            heading.Label.HorizontalAlignment = HAlignment.Left;
            heading.Label.HorizontalExpand = true;
            heading.SetHeight = 29;

            heading.ChevronVisible = false;
            var indicator = new Label { Text = HeadingIndicatorCollapsed };
            if (heading.GetChild(0) is BoxContainer box)
                box.AddChild(indicator);

            heading.OnToggled += args =>
            {
                indicator.Text = args.Pressed ? HeadingIndicatorExpanded : HeadingIndicatorCollapsed;
            };

            var jobList = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Vertical,
                SeparationOverride = 5,
            };

            if (jobs.Length > 1)
            {
                jobList.AddChild(CreateFilterButton(
                    category,
                    Loc.GetString("ghost-target-window-type-filter-all-title"),
                    selected));
            }

            foreach (var job in jobs)
            {
                var capturedJob = job;
                var jobCategory = new WarpCategory(
                    capturedJob,
                    w => w.Where(e => e is PlayerGhostWarp pgw && JobEquals(pgw.jobName, capturedJob)),
                    PlayerDisplayName);

                jobList.AddChild(CreateFilterButton(
                    jobCategory,
                    capturedJob,
                    _selectedCategory?.Label == capturedJob));
            }

            var body = new CollapsibleBody { Margin = new Thickness(8, 5, 0, 0) };
            body.AddChild(jobList);

            var collapsible = new Collapsible(heading, body)
            {
                Orientation = BoxContainer.LayoutOrientation.Vertical,
                HorizontalExpand = true,
            };

            var shouldExpand = _selectedCategory != null &&
                (_selectedCategory.Label == category.Label ||
                 jobs.Any(j => JobEquals(j, _selectedCategory.Label)));

            if (shouldExpand)
            {
                collapsible.BodyVisible = true;
                indicator.Text = HeadingIndicatorExpanded;
            }

            CategoryContainer.AddChild(collapsible);
        }

        public void Populate()
        {
            ButtonContainer.DisposeAllChildren();
            AddButtons();
        }

        private void AddButtons()
        {
            var displayName = _selectedCategory?.DisplayName ?? DefaultDisplayName;

            foreach (var entry in GetSortedWarps())
            {
                var currentButtonRef = new Button
                {
                    Text = displayName(entry),
                    TextAlign = Label.AlignMode.Right,
                    HorizontalAlignment = HAlignment.Center,
                    VerticalAlignment = VAlignment.Center,
                    SizeFlagsStretchRatio = 1,
                    MinSize = new Vector2(340, 20),
                    ClipText = true,
                };

                currentButtonRef.OnPressed += _ => WarpClicked?.Invoke(entry.entity);
                currentButtonRef.Visible = ButtonIsVisible(currentButtonRef);

                ButtonContainer.AddChild(currentButtonRef);
            }
        }

        private IEnumerable<GhostWarp> GetSortedWarps()
        {
            var filtered = _selectedCategory?.Filter(_warps) ?? _warps.AsEnumerable();

            var baseOrder = (_selectedCategory?.WarpsToEnd ?? true)
                ? filtered.OrderBy(w => w.isWarpPoint)
                : filtered.OrderBy(_ => 0);

            return _sortOrderOptions[_sortOrder].Apply(baseOrder, w => w.entityName);
        }

        private bool ButtonIsVisible(Button button)
        {
            return string.IsNullOrEmpty(_searchText) || button.Text == null || button.Text.Contains(_searchText, StringComparison.OrdinalIgnoreCase);
        }

        private sealed class CaseInsensitiveComparer : IEqualityComparer<string>
        {
            public bool Equals(string? x, string? y) =>
                string.Equals(x, y, StringComparison.OrdinalIgnoreCase);

            public int GetHashCode(string obj) =>
                obj.ToUpperInvariant().GetHashCode();
        }

        private void UpdateVisibleButtons()
        {
            foreach (var child in ButtonContainer.Children)
            {
                if (child is Button button)
                    button.Visible = ButtonIsVisible(button);
            }
        }

        private void OnSearchTextChanged(LineEdit.LineEditEventArgs args)
        {
            _searchText = args.Text;

            UpdateVisibleButtons();
            // Reset scroll bar so they can see the relevant results.
            GhostScroll.SetScrollValue(Vector2.Zero);
            CategoryScroll.SetScrollValue(Vector2.Zero);
        }
    }
}

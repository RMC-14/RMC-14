using System.Linq;
using System.Numerics;
using System.Text.RegularExpressions;
using Content.Shared.Ghost;
using Content.Shared.Roles;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;

namespace Content.Client.UserInterface.Systems.Ghost.Controls
{
    [GenerateTypedNameReferences]
    public sealed partial class GhostTargetWindow : DefaultWindow
    {
        private record SortOption(string Label, string Tooltip, string TypeLabel);

        private sealed record FilterOption(
            string Label,
            string Tooltip,
            Func<IEnumerable<GhostWarp>, IEnumerable<GhostWarp>> Apply,
            Func<IEnumerable<GhostWarp>, IOrderedEnumerable<GhostWarp>> Order) : SortOption(Label, Tooltip, "ghost-target-window-type-filter-button");

        private sealed record SortTypeOption(
            string Label,
            string Tooltip,
            Func<GhostWarp, string> KeySelector,
            Func<IOrderedEnumerable<GhostWarp>, IOrderedEnumerable<GhostWarp>> Apply)
            : SortOption(Label, Tooltip, "ghost-target-window-type-sort-by-button");

        private sealed record SortOrderOption(
            string Label,
            string Tooltip,
            Func<IOrderedEnumerable<GhostWarp>, SortTypeOption, IOrderedEnumerable<GhostWarp>> Apply)
            : SortOption(Label, Tooltip, "ghost-target-window-type-sort-dir-button");

        private readonly IPrototypeManager _prototypeManager = default!;
        private List<GhostWarp> _warps = new();
        // ? Loc.GetString("ghost-target-window-current-button", ("name", w.entityName))
        private string _searchText = string.Empty;

        private int _sortOrder;
        private int _sortType;
        private int _filter;

        private static readonly Regex RoleRegex = new(@"\(([^)]+)\)\s*$", RegexOptions.Compiled);

        private static readonly Comparer<string> OrdinalIgnoreCaseComparer =
            Comparer<string>.Create((x, y) => string.Compare(x, y, StringComparison.OrdinalIgnoreCase));

        private readonly SortOrderOption[] _sortOrderOptions;
        private readonly SortTypeOption[] _sortTypeOptions;
        private readonly FilterOption[] _filterOptions;

        public event Action<NetEntity>? WarpClicked;
        public event Action? OnGhostnadoClicked;

        private string[] jobXenoTranslations = default!;

        public GhostTargetWindow()
        {
            RobustXamlLoader.Load(this);
            SearchBar.OnTextChanged += OnSearchTextChanged;

            GhostnadoButton.OnPressed += _ => OnGhostnadoClicked?.Invoke();

            _prototypeManager = IoCManager.Resolve<IPrototypeManager>();

            jobXenoTranslations = _prototypeManager.EnumeratePrototypes<JobPrototype>()
                .Where(j => j.Parents != null && j.Parents.Contains("CMJobXenoBase"))
                .Select(j => j.LocalizedName)
                .ToArray();

            _sortOrderOptions =
            [
                new("↑",
                    "ghost-target-window-type-sort-dir-asc-title",
                    (w, sortType) => w.ThenBy(sortType.KeySelector, OrdinalIgnoreCaseComparer)),
                new("↓",
                    "ghost-target-window-type-sort-dir-desc-title",
                    (w, sortType) => w.ThenByDescending(sortType.KeySelector, OrdinalIgnoreCaseComparer)),
            ];

            _sortTypeOptions =
            [
                new("N",
                    "ghost-target-window-type-sort-by-name-title",
                    w => w.,
                    e => e),
                new("R",
                    "ghost-target-window-type-sort-by-role-title",
                    w => ExtractRole(w.Name),
                    e => e.ThenBy(w => !string.IsNullOrEmpty(ExtractRole(w.Name)))),
            ];

            _filterOptions =
            [
                new("A",
                    "ghost-target-window-type-filter-all-title",
                    w => w,
                    e => e.OrderBy(w => w.IsWarp)),
                new("M",
                    "ghost-target-window-type-filter-marines-title",
                    w => w.Where(e => !e.IsWarp && !jobXenoTranslations.Any(j =>
                        string.Equals(j, ExtractRole(e.Name), StringComparison.OrdinalIgnoreCase))),
                    e => e.OrderBy(w => 0)),
                new("X",
                    "ghost-target-window-type-filter-xeno-title",
                    w => w.Where(e => !e.IsWarp && jobXenoTranslations.Any(j =>
                        string.Equals(j, ExtractRole(e.Name), StringComparison.OrdinalIgnoreCase))),
                    e => e.OrderBy(w => 0)),
                new("W",
                    "ghost-target-window-type-filter-warps-title",
                    w => w.Where(e => e.IsWarp),
                    e => e.OrderBy(w => 0)),
            ];

            UpdateSortButtonAppearance();

            SortOrderButton.OnPressed += _ =>
            {
                _sortOrder = (_sortOrder + 1) % _sortOrderOptions.Length;
                UpdateSortButtonAppearance();
                Populate();
            };

            SortTypeButton.OnPressed += _ =>
            {
                _sortType = (_sortType + 1) % _sortTypeOptions.Length;
                UpdateSortButtonAppearance();
                Populate();
            };

            FilterButton.OnPressed += _ =>
            {
                _filter = (_filter + 1) % _filterOptions.Length;
                UpdateSortButtonAppearance();
                Populate();
            };
        }

        private void UpdateSortButtonAppearance()
        {
            ApplyOption(SortOrderButton, _sortOrderOptions[_sortOrder]);
            ApplyOption(SortTypeButton, _sortTypeOptions[_sortType]);
            ApplyOption(FilterButton, _filterOptions[_filter]);
        }

        private static void ApplyOption(Button button, SortOption option)
        {
            button.Text = option.Label;
            button.HideTooltip();
            var tooltip = new Tooltip();
            tooltip.SetMessage(FormattedMessage.FromUnformatted(Loc.GetString(option.TypeLabel, ("type", Loc.GetString(option.Tooltip)))));
            button.TooltipSupplier = _ => tooltip;
        }

        private static string ExtractRole(string name)
        {
            var match = RoleRegex.Match(name);
            return match.Success ? match.Groups[1].Value : string.Empty;
        }

        public void UpdateWarps(IEnumerable<GhostWarp> warps)
        {
            _warps = warps.ToList();
        }

        public void Populate()
        {
            ButtonContainer.DisposeAllChildren();
            AddButtons();
        }

        private IEnumerable<GhostWarp> GetSortedWarps()
        {
            var filterOption = _filterOptions[_filter];
            var filtered = filterOption.Apply(_warps);

            var baseOrder = filterOption.Order(filtered);

            var sortTypeOption = _sortTypeOptions[_sortType];
            baseOrder = sortTypeOption.Apply(baseOrder);

            var sortOrderOption = _sortOrderOptions[_sortOrder];
            return sortOrderOption.Apply(baseOrder, sortTypeOption);
        }

        private void AddButtons()
        {
            foreach (var entry in GetSortedWarps())
            {
                var currentButtonRef = new Button
                {
                    Text = entry.Name,
                    TextAlign = Label.AlignMode.Right,
                    HorizontalAlignment = HAlignment.Center,
                    VerticalAlignment = VAlignment.Center,
                    SizeFlagsStretchRatio = 1,
                    MinSize = new Vector2(340, 20),
                    ClipText = true,
                };

                currentButtonRef.OnPressed += _ => WarpClicked?.Invoke(entry.Entity);
                currentButtonRef.Visible = ButtonIsVisible(currentButtonRef);

                ButtonContainer.AddChild(currentButtonRef);
            }
        }

        private bool ButtonIsVisible(Button button)
        {
            return string.IsNullOrEmpty(_searchText) || button.Text == null || button.Text.Contains(_searchText, StringComparison.OrdinalIgnoreCase);
        }

        private void UpdateVisibleButtons()
        {
            foreach (var child in ButtonContainer.Children)
            {
                if (child is Button button)
                    button.Visible = ButtonIsVisible(button);
            }
        }

        private void OnSearchTextChanged(LineEdit.LineEditEventArgs args)
        {
            _searchText = args.Text;

            UpdateVisibleButtons();
            // Reset scroll bar so they can see the relevant results.
            GhostScroll.SetScrollValue(Vector2.Zero);
        }
    }
}

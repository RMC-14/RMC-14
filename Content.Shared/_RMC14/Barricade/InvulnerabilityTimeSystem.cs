using Content.Shared.Interaction.Events;
using Content.Shared.Weapons.Melee.Events;
using Content.Shared.Effects;
using Content.Shared.Whitelist;
using Robust.Shared.Timing;
using Robust.Shared.Network;
using Robust.Shared.Player;

namespace Content.Shared._RMC14.Barricade;

public sealed class InvulnerabilityTimeSystem : EntitySystem
{
    [Dependency] private readonly EntityWhitelistSystem _whitelist = default!;
    [Dependency] private readonly IGameTiming _timing = default!;
    [Dependency] private readonly INetManager _net = default!;
    [Dependency] private readonly SharedColorFlashEffectSystem _colorFlash = default!;
    public override void Initialize()
    {
        base.Initialize();

        SubscribeLocalEvent<InvulnerabilityTimeComponent, AttackedEvent>(OnAttack);
        SubscribeLocalEvent<InvulnerabilityTimeComponent, GettingAttackedAttemptEvent>(OnAttackAttempt);
    }

    private void OnAttack(Entity<InvulnerabilityTimeComponent> ent, ref AttackedEvent args)
    {
        if (_whitelist.IsWhitelistPass(ent.Comp.Whitelist, args.User) && _whitelist.IsBlacklistFailOrNull(ent.Comp.Blacklist, args.User))
        {
            ent.Comp.AttacksToExpire.Enqueue(_timing.CurTime + ent.Comp.ExpiryTime);
            Dirty(ent, ent.Comp);
        }
    }

    private void OnAttackAttempt(Entity<InvulnerabilityTimeComponent> ent, ref GettingAttackedAttemptEvent args)
    {
        if (_whitelist.IsWhitelistPass(ent.Comp.Whitelist, args.Attacker) && _whitelist.IsBlacklistFailOrNull(ent.Comp.Blacklist, args.Attacker))
        {
            var time = _timing.CurTime;
            while (ent.Comp.AttacksToExpire.Count > 0)
            {
                if (ent.Comp.AttacksToExpire.TryPeek(out var expireTime) && time >= expireTime)
                {
                    ent.Comp.AttacksToExpire.Dequeue();
                    Dirty(ent, ent.Comp);
                }
                else
                    break;
            }

            if (ent.Comp.AttacksToExpire.Count >= ent.Comp.HitsToInvulnerability)
            {
                args.Cancelled = true;
                if(_net.IsClient)
                    _colorFlash.RaiseEffect(Color.Yellow, new List<EntityUid> { ent }, Filter.PvsExcept(ent));
            }
        }
    }
}
